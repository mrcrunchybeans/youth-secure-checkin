{% extends 'base.html' %}
{% block content %}
<div class="container-fluid py-3">
  <!-- Page Header -->
  <div class="d-flex align-items-center justify-content-between mb-3">
    <div>
      <h2 class="mb-1" style="color: #0dcaf0; font-weight: 700;"><i class="bi bi-envelope"></i> Email Settings</h2>
      <p class="text-muted mb-0">Configure SMTP for sending check-in reports</p>
    </div>
    <div class="d-flex gap-2">
      <a href="{{ url_for('admin_index') }}" class="btn btn-sm btn-outline-secondary"><i class="bi bi-arrow-left"></i> Back</a>
      <a href="{{ url_for('logout') }}" class="btn btn-sm btn-outline-danger"><i class="bi bi-lock"></i> Logout</a>
    </div>
  </div>

  <div class="row">
    <div class="col-lg-8">
      <!-- SMTP Email Settings Card -->
      <div class="card shadow-sm mb-3">
        <div class="card-header py-2" style="background: linear-gradient(135deg, #0dcaf0 0%, #0b8ccc 100%); color: white;">
          <h6 class="mb-0"><i class="bi bi-gear-fill"></i> SMTP Configuration</h6>
        </div>
        <div class="card-body p-3">
          <div class="border rounded p-3 bg-light mb-3">
            <div class="d-flex align-items-center justify-content-between mb-2">
              <label class="form-label mb-0 small fw-semibold">
                <i class="bi bi-lock-fill text-warning"></i> SMTP Settings
              </label>
              {% if smtp_unlocked %}
              <span class="badge bg-success small">Unlocked</span>
              {% else %}
              <span class="badge bg-warning text-dark small">Protected</span>
              {% endif %}
            </div>
            
            {% if smtp_unlocked %}
            <!-- Show SMTP settings when unlocked -->
            <form method="POST" class="needs-validation" novalidate>
              <div class="row g-3">
                <div class="col-12">
                  <label for="smtp_server" class="form-label small fw-semibold mb-1">SMTP Server</label>
                  <input type="text" class="form-control form-control-sm" id="smtp_server" name="smtp_server"
                         value="{{ smtp_settings.smtp_server or '' }}" placeholder="e.g., smtp.gmail.com" required>
                  <div class="text-muted" style="font-size: 0.75rem;">SMTP server hostname</div>
                </div>
                
                <div class="col-md-6">
                  <label for="smtp_port" class="form-label small fw-semibold mb-1">Port</label>
                  <input type="number" class="form-control form-control-sm" id="smtp_port" name="smtp_port"
                         value="{{ smtp_settings.smtp_port or '587' }}" placeholder="587 or 465" required>
                  <div class="text-muted" style="font-size: 0.75rem;">Usually 587 (TLS) or 465 (SSL)</div>
                </div>
                
                <div class="col-md-6">
                  <label for="smtp_from" class="form-label small fw-semibold mb-1">From Address</label>
                  <input type="email" class="form-control form-control-sm" id="smtp_from" name="smtp_from"
                         value="{{ smtp_settings.smtp_from or '' }}" placeholder="checkin@example.com" required>
                  <div class="text-muted" style="font-size: 0.75rem;">Sender email address</div>
                </div>
                
                <div class="col-md-6">
                  <label for="smtp_username" class="form-label small fw-semibold mb-1">Username</label>
                  <input type="text" class="form-control form-control-sm" id="smtp_username" name="smtp_username"
                         value="{{ smtp_settings.smtp_username or '' }}" placeholder="username or email" required>
                  <div class="text-muted" style="font-size: 0.75rem;">SMTP authentication username</div>
                </div>
                
                <div class="col-md-6">
                  <label for="smtp_password" class="form-label small fw-semibold mb-1">Password</label>
                  <input type="password" class="form-control form-control-sm" id="smtp_password" name="smtp_password"
                         placeholder="Leave blank to keep current">
                  <div class="text-muted" style="font-size: 0.75rem;">SMTP password (leave blank to not change)</div>
                </div>
                
                <div class="col-12">
                  <div class="form-check form-switch">
                    <input type="checkbox" class="form-check-input" id="smtp_use_tls" name="smtp_use_tls"
                           {% if smtp_settings.smtp_use_tls == 'true' %}checked{% endif %} style="cursor: pointer;">
                    <label class="form-check-label small" for="smtp_use_tls" style="cursor: pointer;">
                      Use TLS encryption (port 587)
                    </label>
                  </div>
                </div>
                
                <div class="col-12">
                  <button type="submit" name="action" value="save_smtp" class="btn btn-sm" style="background: #0dcaf0; color: white;">
                    <i class="bi bi-check-circle"></i> Save SMTP Settings
                  </button>
                  <form method="POST" action="{{ url_for('lock_smtp') }}" style="display: inline;">
                    <button type="submit" class="btn btn-sm btn-outline-secondary ms-2">
                      <i class="bi bi-lock"></i> Lock Settings
                    </button>
                  </form>
                </div>
              </div>
            </form>
            {% else %}
              <!-- Show unlock form when locked -->
              <form method="POST" action="{{ url_for('unlock_smtp') }}">
                <div class="row g-2 align-items-end">
                  <div class="col-md-6">
                    <input type="password" class="form-control form-control-sm" name="dev_password" 
                           placeholder="Enter developer password" required autofocus>
                    <div class="text-muted" style="font-size: 0.75rem;">
                      <i class="bi bi-shield-exclamation"></i> Developer password required to view/edit
                    </div>
                  </div>
                  <div class="col-md-3">
                    <button type="submit" class="btn btn-sm btn-warning w-100">
                      <i class="bi bi-unlock"></i> Unlock
                    </button>
                  </div>
                </div>
              </form>
            {% endif %}
          </div>
          
          <div class="alert alert-info p-2 mb-0 small">
            <i class="bi bi-info-circle"></i> <strong>Required:</strong> Server, Port, From Address, Username & Password. Used for sending check-in history reports.
          </div>
        </div>
      </div>

      <!-- Test Email Card -->
      <div class="card shadow-sm">
        <div class="card-header py-2" style="background: linear-gradient(135deg, #0dcaf0 0%, #0b8ccc 100%); color: white;">
          <h6 class="mb-0"><i class="bi bi-envelope-check"></i> Test Email</h6>
        </div>
        <div class="card-body p-3">
          <p class="text-muted small mb-3">Send a test email to verify your SMTP settings are working correctly.</p>
          <form method="POST" action="{{ url_for('test_email') }}">
            <div class="row g-2 align-items-end">
              <div class="col-md-6">
                <input type="email" class="form-control form-control-sm" name="test_email" 
                       placeholder="your.email@example.com" required>
              </div>
              <div class="col-md-3">
                <button type="submit" class="btn btn-sm btn-info w-100" style="color: white;">
                  <i class="bi bi-send"></i> Send Test
                </button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Info Sidebar -->
    <div class="col-lg-4">
      <div class="card shadow-sm mb-3">
        <div class="card-header py-2" style="background: #e7f3ff; color: #0066cc; font-weight: 600;">
          <i class="bi bi-lightbulb"></i> Common SMTP Servers
        </div>
        <div class="card-body p-3 small">
          <div class="mb-3">
            <strong>Gmail:</strong>
            <ul class="mb-2 mt-1">
              <li>Server: smtp.gmail.com</li>
              <li>Port: 587 (TLS)</li>
              <li>Username: your@gmail.com</li>
              <li class="text-muted">Use <a href="https://support.google.com/accounts/answer/185833" target="_blank" class="text-decoration-none">App Password</a></li>
            </ul>
          </div>
          <div class="mb-3">
            <strong>Outlook/Office365:</strong>
            <ul class="mb-2 mt-1">
              <li>Server: smtp.office365.com</li>
              <li>Port: 587 (TLS)</li>
              <li>Username: your@outlook.com</li>
            </ul>
          </div>
          <div>
            <strong>Custom Server:</strong>
            <ul class="mt-1">
              <li>Check your email provider's documentation</li>
              <li>Usually requires TLS or SSL</li>
            </ul>
          </div>
        </div>
      </div>

      <div class="alert alert-success small">
        <i class="bi bi-shield-check"></i> <strong>Secure Storage:</strong> Your SMTP password is stored securely and only used for sending emails.
      </div>
    </div>
  </div>

</div>
{% endblock %}
