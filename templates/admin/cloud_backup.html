{% extends 'base.html' %}
{% block content %}
<div class="container-fluid py-3">
  <!-- Page Header -->
  <div class="d-flex align-items-center justify-content-between mb-3">
    <div>
      <h2 class="mb-1" style="color: #0dcaf0; font-weight: 700;"><i class="bi bi-cloud-upload"></i> Cloud Backup</h2>
      <p class="text-muted mb-0">Automatic backups to Google Drive, OneDrive, and Dropbox</p>
    </div>
    <div class="d-flex gap-2">
      <a href="{{ url_for('cloud_backup_credentials') }}" class="btn btn-sm btn-warning"><i class="bi bi-shield-lock"></i> Credentials</a>
      <a href="{{ url_for('admin_index') }}" class="btn btn-sm btn-outline-secondary"><i class="bi bi-arrow-left"></i> Back</a>
      <a href="{{ url_for('logout') }}" class="btn btn-sm btn-outline-danger"><i class="bi bi-lock"></i> Logout</a>
    </div>
  </div>

  <div class="row">
    <div class="col-lg-8">
      <!-- Backup Status Card -->
      <div class="card shadow-sm mb-3">
        <div class="card-header py-2" style="background: linear-gradient(135deg, #0dcaf0 0%, #0b8ccc 100%); color: white;">
          <h6 class="mb-0"><i class="bi bi-cloud-check"></i> Backup Status</h6>
        </div>
        <div class="card-body p-3">
          {% if last_backup %}
            <div class="alert alert-success small">
              <i class="bi bi-check-circle"></i> <strong>Last Backup:</strong> {{ last_backup.timestamp }}
            </div>
            <div class="row small">
              {% if last_backup.google_drive %}
                <div class="col-md-6 mb-2">
                  <div class="p-2" style="background: #f0f8ff; border-left: 3px solid #4285F4;">
                    <strong>Google Drive:</strong> 
                    {% if last_backup.google_drive.success %}
                      <span class="badge bg-success">✓ Success</span>
                    {% else %}
                      <span class="badge bg-danger">✗ Failed</span>
                    {% endif %}
                  </div>
                </div>
              {% endif %}
              {% if last_backup.dropbox %}
                <div class="col-md-6 mb-2">
                  <div class="p-2" style="background: #f0f8ff; border-left: 3px solid #0061FF;">
                    <strong>Dropbox:</strong>
                    {% if last_backup.dropbox.success %}
                      <span class="badge bg-success">✓ Success</span>
                    {% else %}
                      <span class="badge bg-danger">✗ Failed</span>
                    {% endif %}
                  </div>
                </div>
              {% endif %}
              {% if last_backup.onedrive %}
                <div class="col-md-6 mb-2">
                  <div class="p-2" style="background: #f0f8ff; border-left: 3px solid #0078D4;">
                    <strong>OneDrive:</strong>
                    {% if last_backup.onedrive.success %}
                      <span class="badge bg-success">✓ Success</span>
                    {% else %}
                      <span class="badge bg-danger">✗ Failed</span>
                    {% endif %}
                  </div>
                </div>
              {% endif %}
            </div>
          {% else %}
            <div class="alert alert-info small mb-0">
              <i class="bi bi-info-circle"></i> No backups yet. Configure services and take a manual backup to get started.
            </div>
          {% endif %}
        </div>
      </div>

      <!-- Credentials Setup Alert -->
      <div class="alert alert-primary mb-3">
        <i class="bi bi-shield-lock"></i> <strong>First Time Setup:</strong> Before connecting services, you need to configure your OAuth credentials. Click the <strong>"Credentials"</strong> button above to set up your Google Drive, Dropbox, and OneDrive OAuth applications.
      </div>

      <!-- Manual Backup Card -->
      <div class="card shadow-sm mb-3">
        <div class="card-header py-2" style="background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%); color: white;">
          <h6 class="mb-0"><i class="bi bi-arrow-up-circle"></i> Manual Backup</h6>
        </div>
        <div class="card-body p-3">
          <p class="small text-muted mb-3">Create an immediate backup to all configured cloud services.</p>
          <form method="POST" action="{{ url_for('backup_now') }}">
            <button type="submit" class="btn btn-success">
              <i class="bi bi-cloud-upload"></i> Backup Now
            </button>
          </form>
        </div>
      </div>

      <!-- Google Drive Configuration -->
      <div class="card shadow-sm mb-3">
        <div class="card-header py-2" style="background: linear-gradient(135deg, #4285F4 0%, #1a73e8 100%); color: white;">
          <h6 class="mb-0"><i class="bi bi-google"></i> Google Drive</h6>
        </div>
        <div class="card-body p-3">
          {% if google_drive_configured %}
            <div class="alert alert-success small mb-3">
              <i class="bi bi-check-circle"></i> Google Drive is configured and ready for backups.
            </div>
            <div class="btn-group" role="group">
              <form method="POST" action="{{ url_for('backup_now') }}" style="display: inline;">
                <button type="submit" class="btn btn-sm btn-primary">
                  <i class="bi bi-arrow-clockwise"></i> Test Connection
                </button>
              </form>
              <form method="POST" action="{{ url_for('disconnect_cloud_service', service='google') }}" style="display: inline;">
                <button type="submit" onclick="return confirm('Disconnect Google Drive? You will need to re-authenticate to resume backups.')" class="btn btn-sm btn-danger">
                  <i class="bi bi-trash"></i> Disconnect
                </button>
              </form>
            </div>
          {% else %}
            <p class="small text-muted mb-3">Connect your Google Drive account for automatic backups.</p>
            <a href="{{ url_for('oauth_google') }}" class="btn btn-sm btn-primary">
              <i class="bi bi-box-arrow-up-right"></i> Connect Google Drive
            </a>
            <div class="alert alert-info small mt-3 mb-0">
              <i class="bi bi-info-circle"></i> You'll be redirected to Google to authorize access.
            </div>
          {% endif %}
        </div>
      </div>

      <!-- Dropbox Configuration -->
      <div class="card shadow-sm mb-3">
        <div class="card-header py-2" style="background: linear-gradient(135deg, #0061FF 0%, #003a99 100%); color: white;">
          <h6 class="mb-0"><i class="bi bi-droplet"></i> Dropbox</h6>
        </div>
        <div class="card-body p-3">
          {% if dropbox_configured %}
            <div class="alert alert-success small mb-3">
              <i class="bi bi-check-circle"></i> Dropbox is configured and ready for backups.
            </div>
            <div class="btn-group" role="group">
              <form method="POST" action="{{ url_for('backup_now') }}" style="display: inline;">
                <button type="submit" class="btn btn-sm btn-primary">
                  <i class="bi bi-arrow-clockwise"></i> Test Connection
                </button>
              </form>
              <form method="POST" action="{{ url_for('disconnect_cloud_service', service='dropbox') }}" style="display: inline;">
                <button type="submit" onclick="return confirm('Disconnect Dropbox? You will need to re-authenticate to resume backups.')" class="btn btn-sm btn-danger">
                  <i class="bi bi-trash"></i> Disconnect
                </button>
              </form>
            </div>
          {% else %}
            <p class="small text-muted mb-3">Connect your Dropbox account for automatic backups.</p>
            <a href="{{ url_for('oauth_dropbox') }}" class="btn btn-sm btn-primary">
              <i class="bi bi-box-arrow-up-right"></i> Connect Dropbox
            </a>
            <div class="alert alert-info small mt-3 mb-0">
              <i class="bi bi-info-circle"></i> You'll be redirected to Dropbox to authorize access.
            </div>
          {% endif %}
        </div>
      </div>

      <!-- OneDrive Configuration -->
      <div class="card shadow-sm mb-3">
        <div class="card-header py-2" style="background: linear-gradient(135deg, #0078D4 0%, #004B87 100%); color: white;">
          <h6 class="mb-0"><i class="bi bi-microsoft"></i> OneDrive</h6>
        </div>
        <div class="card-body p-3">
          {% if onedrive_configured %}
            <div class="alert alert-success small mb-3">
              <i class="bi bi-check-circle"></i> OneDrive is configured and ready for backups.
            </div>
            <div class="btn-group" role="group">
              <form method="POST" action="{{ url_for('backup_now') }}" style="display: inline;">
                <button type="submit" class="btn btn-sm btn-primary">
                  <i class="bi bi-arrow-clockwise"></i> Test Connection
                </button>
              </form>
              <form method="POST" action="{{ url_for('disconnect_cloud_service', service='onedrive') }}" style="display: inline;">
                <button type="submit" onclick="return confirm('Disconnect OneDrive? You will need to re-authenticate to resume backups.')" class="btn btn-sm btn-danger">
                  <i class="bi bi-trash"></i> Disconnect
                </button>
              </form>
            </div>
          {% else %}
            <p class="small text-muted mb-3">Connect your OneDrive account for automatic backups.</p>
            <a href="{{ url_for('oauth_onedrive') }}" class="btn btn-sm btn-primary">
              <i class="bi bi-box-arrow-up-right"></i> Connect OneDrive
            </a>
            <div class="alert alert-info small mt-3 mb-0">
              <i class="bi bi-info-circle"></i> You'll be redirected to Microsoft to authorize access.
            </div>
          {% endif %}
        </div>
      </div>

      <!-- Backup Schedule Card -->
      <div class="card shadow-sm">
        <div class="card-header py-2" style="background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%); color: white;">
          <h6 class="mb-0"><i class="bi bi-calendar-check"></i> Backup Schedule</h6>
        </div>
        <div class="card-body p-3">
          <form method="POST">
            <div class="row g-3">
              <div class="col-md-6">
                <label for="backup_frequency" class="form-label small fw-semibold mb-1">Frequency</label>
                <select name="backup_frequency" id="backup_frequency" class="form-select form-select-sm">
                  <option value="hourly" {% if backup_frequency == 'hourly' %}selected{% endif %}>Every Hour</option>
                  <option value="daily" {% if backup_frequency == 'daily' %}selected{% endif %}>Daily</option>
                  <option value="weekly" {% if backup_frequency == 'weekly' %}selected{% endif %}>Weekly</option>
                  <option value="monthly" {% if backup_frequency == 'monthly' %}selected{% endif %}>Monthly</option>
                </select>
              </div>
              <div class="col-md-6">
                <label for="backup_hour" class="form-label small fw-semibold mb-1">Time (UTC)</label>
                <select name="backup_hour" id="backup_hour" class="form-select form-select-sm">
                  {% for h in range(24) %}
                    <option value="{{ h }}" {% if backup_hour == h %}selected{% endif %}>{{ "%02d"|format(h) }}:00</option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-12">
                <button type="submit" name="action" value="save_schedule" class="btn btn-sm btn-secondary">
                  <i class="bi bi-check-circle"></i> Save Schedule
                </button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Info Sidebar -->
    <div class="col-lg-4">
      <div class="card shadow-sm mb-3">
        <div class="card-header py-2" style="background: #e7f3ff; color: #0066cc; font-weight: 600;">
          <i class="bi bi-shield-check"></i> What Gets Backed Up
        </div>
        <div class="card-body p-3 small">
          <ul class="list-unstyled">
            <li>✓ Entire SQLite database</li>
            <li>✓ All family records</li>
            <li>✓ Check-in/check-out history</li>
            <li>✓ Event information</li>
            <li>✓ Configuration settings</li>
            <li>✓ User preferences</li>
          </ul>
        </div>
      </div>

      <div class="card shadow-sm mb-3">
        <div class="card-header py-2" style="background: #e7f3ff; color: #0066cc; font-weight: 600;">
          <i class="bi bi-info-circle"></i> Backup Info
        </div>
        <div class="card-body p-3 small">
          <p><strong>Automatic Backups:</strong> Run on your configured schedule.</p>
          <p><strong>Storage:</strong> Each service stores backups independently.</p>
          <p><strong>Retention:</strong> Keep backups as long as your cloud storage allows.</p>
          <p class="mb-0"><strong>Encryption:</strong> All data is encrypted in transit.</p>
        </div>
      </div>

      <div class="alert alert-warning small">
        <i class="bi bi-exclamation-triangle"></i> <strong>Important:</strong> Configure at least one cloud service to enable automatic backups.
      </div>
    </div>
  </div>

</div>
{% endblock %}
