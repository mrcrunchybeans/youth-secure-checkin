{% extends 'base.html' %}
{% block content %}
<div class="container">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2>Events</h2>
    <div>
      <a href="/admin/events/add" class="btn btn-primary">
        <i class="bi bi-plus-circle"></i> Add Event
      </a>
      <a href="/admin/history/export" class="btn btn-success">
        <i class="bi bi-download"></i> Export History
      </a>
    </div>
  </div>

  <div class="card mb-3">
    <div class="card-header" style="background-color: {{ branding.primary_color }}; color: white;">
      <strong>iCal Sync Configuration</strong>
    </div>
    <div class="card-body">
      <form method="post" action="/admin/events/set_ical">
        <label class="form-label fw-bold">iCal URL</label>
        <div class="input-group mb-3">
          <input name="ical_url" class="form-control" value="{{ ical_url or '' }}" placeholder="https://example.com/calendar.ics" />
          <button type="submit" class="btn" style="background-color: {{ branding.primary_color }}; color: white; border: none;">Save URL</button>
        </div>
      </form>

      <div class="alert alert-info mb-3">
        <strong>üîÑ Auto-Sync Active:</strong> Events automatically sync every hour from your iCal URL.
        <br>
        <small><strong>Last Sync:</strong> {{ last_sync }}</small>
      </div>

      <form method="post" action="/admin/events/sync" class="d-inline">
        <button type="submit" class="btn btn-outline-secondary">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-clockwise" viewBox="0 0 16 16" style="margin-bottom: 2px;">
            <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/>
            <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/>
          </svg>
          Sync Now (Manual)
        </button>
      </form>
    </div>
  </div>

  <div class="card">
    <div class="card-header d-flex justify-content-between align-items-center" 
         style="background-color: {{ branding.secondary_color }}; color: white;">
      <strong>Events List</strong>
      <form method="post" action="/admin/events/clear" class="d-inline"
            onsubmit="return confirm('Are you sure you want to delete ALL events?')">
        <button type="submit" class="btn btn-sm btn-danger">
          <i class="bi bi-trash"></i> Clear All Events
        </button>
      </form>
    </div>
    <div class="card-body p-0">
      <table class="table table-hover mb-0">
        <thead>
          <tr>
            <th>Name</th>
            <th>Date</th>
            <th>Time</th>
            <th>Description</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% if events %}
            {% for e in events %}
              <tr>
                <td>{{ e['name'] }}</td>
                <td>{{ e['start_time'][:10] if e['start_time'] else '‚Äî' }}</td>
                <td>{{ e['start_time'][11:16] if e['start_time'] else '‚Äî' }} - {{ e['end_time'][11:16] if e['end_time'] else '‚Äî' }}</td>
                <td>{{ e['description'][:50] or '‚Äî' }}{% if e['description'] and e['description']|length > 50 %}...{% endif %}</td>
                <td>
                  <a href="/admin/events/edit/{{ e['id'] }}" class="btn btn-sm btn-outline-secondary">
                    <i class="bi bi-pencil"></i> Edit
                  </a>
                </td>
              </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="5" class="text-center text-muted py-4">
                <i class="bi bi-calendar-x" style="font-size: 2rem;"></i>
                <p class="mb-0 mt-2">No events yet. Add an event manually or import from iCal.</p>
              </td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>

  <div class="mt-3">
    <a href="/admin" class="btn btn-outline-secondary">‚Üê Back to Admin</a>
  </div>
</div>
{% endblock %}