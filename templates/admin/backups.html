{% extends 'base.html' %}
{% block content %}
<div class="container">
  <h2>Backup Management</h2>
  
  <!-- Backup Summary Card -->
  <div class="card mb-4">
    <div class="card-body">
      <h5 class="card-title">Backup Status</h5>
      <div class="row">
        <div class="col-md-3">
          <div class="text-center">
            <h3 class="mb-0">{{ summary.total_backups }}</h3>
            <small class="text-muted">Total Backups</small>
          </div>
        </div>
        <div class="col-md-3">
          <div class="text-center">
            <h3 class="mb-0">{{ summary.recent_backups }}</h3>
            <small class="text-muted">Recent (0-7 days)</small>
          </div>
        </div>
        <div class="col-md-3">
          <div class="text-center">
            <h3 class="mb-0">{{ summary.weekly_backups }}</h3>
            <small class="text-muted">Weekly (7-30 days)</small>
          </div>
        </div>
        <div class="col-md-3">
          <div class="text-center">
            <h3 class="mb-0">{{ (summary.total_size_mb / 1024) | round(2) }} GB</h3>
            <small class="text-muted">Total Size</small>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Retention Policy Info -->
  <div class="alert alert-info" role="alert">
    <i class="bi bi-info-circle"></i> <strong>Retention Policy:</strong> Keeps last 3 backups, plus 1 weekly backup (7+ days old), and 1 monthly backup (30+ days old).
  </div>

  <!-- Create Backup & Schedule -->
  <div class="row mb-4">
    <div class="col-md-6">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Create New Backup</h5>
          <form method="post" action="/admin/backups/create">
            <div class="mb-3">
              <label for="description" class="form-label">Description <small class="text-muted">(optional)</small></label>
              <input type="text" class="form-control" id="description" name="description" placeholder="e.g., Before major update, Weekly backup">
              <small class="text-muted">Add a note to help identify this backup later</small>
            </div>
            <div class="d-flex gap-2">
              <button type="submit" class="btn btn-primary flex-fill">
                <i class="bi bi-plus-circle"></i> Create Backup
              </button>
              <form method="post" action="/admin/backups/rotate" class="flex-fill">
                <button type="submit" class="btn btn-secondary w-100" title="Remove old backups beyond retention policy">
                  <i class="bi bi-arrow-clockwise"></i> Clean Old Backups
                </button>
              </form>
            </div>
            <small class="text-muted d-block mt-2"><i class="bi bi-info-circle"></i> "Clean Old Backups" removes backups that exceed the retention policy (keeps last 3 + 1 weekly + 1 monthly)</small>
          </form>
        </div>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Automatic Backup Schedule</h5>
          <form method="post" action="/admin/backups/schedule">
            <div class="mb-3">
              <label for="backup_frequency" class="form-label">Frequency</label>
              <select class="form-select" id="backup_frequency" name="backup_frequency">
                <option value="hourly" {% if backup_frequency == 'hourly' %}selected{% endif %}>Hourly</option>
                <option value="daily" {% if backup_frequency == 'daily' %}selected{% endif %}>Daily</option>
                <option value="weekly" {% if backup_frequency == 'weekly' %}selected{% endif %}>Weekly (Saturdays)</option>
                <option value="monthly" {% if backup_frequency == 'monthly' %}selected{% endif %}>Monthly (1st of month)</option>
              </select>
              <small class="text-muted">How often to automatically create backups</small>
            </div>
            <div class="mb-3">
              <label for="backup_hour" class="form-label">Time (hour of day, 0-23)</label>
              <input type="number" class="form-control" id="backup_hour" name="backup_hour" value="{{ backup_hour }}" min="0" max="23">
              <small class="text-muted">24-hour format (e.g., 2 = 2 AM, 14 = 2 PM)</small>
            </div>
            <button type="submit" class="btn btn-success w-100">
              <i class="bi bi-calendar-check"></i> Update Schedule
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Email Backup Configuration -->
  <div class="card mb-4">
    <div class="card-body">
      <h5 class="card-title"><i class="bi bi-envelope"></i> Email Backup Delivery</h5>
      <div class="alert alert-info mb-3">
        <i class="bi bi-info-circle"></i> Automatically email backups to specified addresses when created. Requires SMTP settings configured in <a href="{{ url_for('admin_email') }}">Email Settings</a>.
      </div>
      <form method="post" action="/admin/backups/email-config">
        <div class="row">
          <div class="col-md-8">
            <label for="backup_email_recipients" class="form-label">Recipient Email Addresses</label>
            <input type="text" class="form-control" id="backup_email_recipients" name="backup_email_recipients" 
                   value="{{ backup_email_recipients or '' }}" 
                   placeholder="admin@example.com, backup@example.com">
            <small class="text-muted">Comma-separated list of email addresses to receive backups</small>
          </div>
          <div class="col-md-4">
            <label class="form-label">&nbsp;</label>
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="backup_email_enabled" name="backup_email_enabled" 
                     {% if backup_email_enabled == 'true' %}checked{% endif %}>
              <label class="form-check-label" for="backup_email_enabled">
                Enable automatic email delivery
              </label>
            </div>
            <button type="submit" class="btn btn-primary mt-2 w-100">
              <i class="bi bi-check-circle"></i> Save Email Settings
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Backup Encryption -->
  <div class="card mb-4">
    <div class="card-body">
      <h5 class="card-title"><i class="bi bi-shield-lock"></i> Backup Encryption</h5>
      
      {% if not encryption_available %}
      <div class="alert alert-warning mb-3">
        <i class="bi bi-exclamation-triangle"></i> <strong>Encryption unavailable.</strong> The <code>pyzipper</code> package is not installed. Contact your administrator to enable encryption.
      </div>
      {% else %}
      
      <div class="alert alert-info mb-3">
        <i class="bi bi-info-circle"></i> Encrypt backups with AES-256 to protect sensitive child information. Encrypted backups require the password to restore or open.
      </div>
      
      {% if backup_encryption_enabled %}
      <!-- Encryption is enabled -->
      <div class="alert alert-success mb-3">
        <i class="bi bi-shield-check"></i> <strong>Encryption enabled.</strong> All new backups are encrypted with AES-256.
      </div>
      
      <div class="row">
        <div class="col-md-6">
          <!-- Change password form -->
          <form method="post" action="/admin/backups/encryption-config">
            <input type="hidden" name="action" value="change">
            <h6 class="mb-3">Change Encryption Password</h6>
            <div class="mb-2">
              <input type="password" class="form-control form-control-sm" name="current_encryption_password" 
                     placeholder="Current password" required>
            </div>
            <div class="mb-2">
              <input type="password" class="form-control form-control-sm" name="new_encryption_password" 
                     placeholder="New password (min 8 chars)" minlength="8" required>
            </div>
            <div class="mb-2">
              <input type="password" class="form-control form-control-sm" name="new_encryption_password_confirm" 
                     placeholder="Confirm new password" required>
            </div>
            <button type="submit" class="btn btn-warning btn-sm w-100">
              <i class="bi bi-key"></i> Change Password
            </button>
          </form>
        </div>
        <div class="col-md-6">
          <!-- Disable encryption -->
          <form method="post" action="/admin/backups/encryption-config" onsubmit="return confirm('Are you sure you want to disable encryption? New backups will no longer be protected.');">
            <input type="hidden" name="action" value="disable">
            <h6 class="mb-3">Disable Encryption</h6>
            <p class="text-muted small">New backups will no longer be encrypted. Existing encrypted backups will still require the password to restore.</p>
            <button type="submit" class="btn btn-outline-danger btn-sm w-100">
              <i class="bi bi-shield-x"></i> Disable Encryption
            </button>
          </form>
        </div>
      </div>
      
      {% else %}
      <!-- Encryption is disabled -->
      <form method="post" action="/admin/backups/encryption-config">
        <input type="hidden" name="action" value="enable">
        <div class="row">
          <div class="col-md-5">
            <label for="backup_encryption_password" class="form-label">Encryption Password</label>
            <input type="password" class="form-control" id="backup_encryption_password" name="backup_encryption_password" 
                   placeholder="Minimum 8 characters" minlength="8" required>
          </div>
          <div class="col-md-5">
            <label for="backup_encryption_password_confirm" class="form-label">Confirm Password</label>
            <input type="password" class="form-control" id="backup_encryption_password_confirm" name="backup_encryption_password_confirm" 
                   placeholder="Re-enter password" required>
          </div>
          <div class="col-md-2 d-flex align-items-end">
            <button type="submit" class="btn btn-success w-100">
              <i class="bi bi-shield-lock"></i> Enable
            </button>
          </div>
        </div>
        <small class="text-muted mt-2 d-block"><strong>Important:</strong> Store this password securely! You'll need it to restore backups.</small>
      </form>
      {% endif %}
      
      {% endif %}
    </div>
  </div>

  <!-- Backup List -->
  <div class="card">
    <div class="card-body">
      <h5 class="card-title">Available Backups</h5>
      
      <!-- Action Button Legend -->
      <div class="mb-3 small text-muted">
        <strong>Actions:</strong>
        <span class="ms-2"><span class="badge bg-success"><i class="bi bi-download"></i></span> Download</span>
        <span class="ms-2"><span class="badge bg-warning"><i class="bi bi-arrow-counterclockwise"></i></span> Restore</span>
        <span class="ms-2"><span class="badge bg-danger"><i class="bi bi-trash"></i></span> Delete</span>
      </div>
      
      {% if backups %}
      <div class="table-responsive">
        <table class="table table-hover">
          <thead>
            <tr>
              <th>Filename</th>
              <th>Date</th>
              <th>Age</th>
              <th>Size</th>
              <th>Security</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for backup in backups %}
            <tr>
              <td><code>{{ backup.filename }}</code></td>
              <td>{{ backup.created_str }}</td>
              <td>
                {% if backup.age_days == 0 %}
                  <span class="badge bg-success">Today</span>
                {% elif backup.age_days < 7 %}
                  <span class="badge bg-primary">{{ backup.age_days }}d ago</span>
                {% elif backup.age_days < 30 %}
                  <span class="badge bg-info">{{ backup.age_days }}d ago</span>
                {% else %}
                  <span class="badge bg-secondary">{{ backup.age_days }}d ago</span>
                {% endif %}
              </td>
              <td>{{ backup.size_mb }} MB</td>
              <td>
                {% if backup.encrypted %}
                  <span class="badge bg-success" title="AES-256 Encrypted"><i class="bi bi-shield-lock-fill"></i> Encrypted</span>
                {% else %}
                  <span class="badge bg-warning text-dark" title="Not encrypted"><i class="bi bi-unlock"></i> Unencrypted</span>
                {% endif %}
              </td>
              <td>
                <div class="btn-group" role="group">
                  <a href="/admin/backups/download/{{ backup.filename }}" class="btn btn-sm btn-success" title="Download">
                    <i class="bi bi-download"></i>
                  </a>
                  <button type="button" class="btn btn-sm btn-warning" data-bs-toggle="modal" data-bs-target="#restoreModal{{ loop.index }}" title="Restore">
                    <i class="bi bi-arrow-counterclockwise"></i>
                  </button>
                  <button type="button" class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#deleteModal{{ loop.index }}" title="Delete">
                    <i class="bi bi-trash"></i>
                  </button>
                </div>

                <!-- Restore Confirmation Modal -->
                <div class="modal fade" id="restoreModal{{ loop.index }}" tabindex="-1">
                  <div class="modal-dialog">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h5 class="modal-title">Confirm Restore</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                      </div>
                      <div class="modal-body">
                        <div class="alert alert-warning">
                          <i class="bi bi-exclamation-triangle"></i> <strong>Warning:</strong> This will replace your current database with the backup from <strong>{{ backup.created_str }}</strong>. A pre-restore backup will be created automatically.
                        </div>
                        {% if backup.encrypted %}
                        <div class="alert alert-info">
                          <i class="bi bi-shield-lock"></i> This backup is encrypted. The system will use the configured encryption password to restore it.
                        </div>
                        {% endif %}
                        <p>Type <strong>RESTORE</strong> to confirm:</p>
                        <form method="post" action="/admin/backups/restore/{{ backup.filename }}" id="restoreForm{{ loop.index }}">
                          <input type="text" class="form-control" name="confirm" placeholder="Type RESTORE to confirm" required pattern="[Rr][Ee][Ss][Tt][Oo][Rr][Ee]">
                        </form>
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" form="restoreForm{{ loop.index }}" class="btn btn-warning">Restore Backup</button>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Delete Confirmation Modal -->
                <div class="modal fade" id="deleteModal{{ loop.index }}" tabindex="-1">
                  <div class="modal-dialog">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h5 class="modal-title">Confirm Delete</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                      </div>
                      <div class="modal-body">
                        <p>Are you sure you want to delete this backup?</p>
                        <p><strong>{{ backup.filename }}</strong> ({{ backup.size_mb }} MB)</p>
                        <p class="text-muted">This action cannot be undone.</p>
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <form method="post" action="/admin/backups/delete/{{ backup.filename }}" style="display: inline;">
                          <button type="submit" class="btn btn-danger">Delete Backup</button>
                        </form>
                      </div>
                    </div>
                  </div>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="alert alert-info">
        <i class="bi bi-info-circle"></i> No backups found. Create your first backup using the form above.
      </div>
      {% endif %}
    </div>
  </div>

  <div class="mt-3">
    <a href="/admin" class="btn btn-secondary">
      <i class="bi bi-arrow-left"></i> Back to Admin Panel
    </a>
  </div>
</div>
{% endblock %}
