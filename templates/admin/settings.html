{% extends 'base.html' %}
{% block content %}
<div class="container-fluid py-3">
  <!-- Page Header -->
  <div class="d-flex align-items-center justify-content-between mb-3">
    <div>
      <h2 class="mb-1" style="color: {{ branding.primary_color }}; font-weight: 700;"><i class="bi bi-gear-fill"></i> Settings</h2>
      <p class="text-muted mb-0">Configure security, checkout, and branding</p>
    </div>
    <div class="d-flex gap-2">
      <a href="{{ url_for('admin_index') }}" class="btn btn-sm btn-outline-secondary"><i class="bi bi-arrow-left"></i> Back</a>
      <a href="{{ url_for('logout') }}" class="btn btn-sm btn-outline-danger"><i class="bi bi-lock"></i> Logout</a>
    </div>
  </div>

<div class="row g-3">
  <!-- Left Column -->
  <div class="col-lg-8">
    <!-- Security Settings Card -->
    <div class="card shadow-sm mb-3">
      <div class="card-header py-2" style="background: linear-gradient(135deg, {{ branding.primary_color }} 0%, {{ branding.primary_color }} 100%); color: white;">
        <h6 class="mb-0"><i class="bi bi-shield-lock"></i> Security</h6>
      </div>
      <div class="card-body p-3">
        <form method="POST" class="needs-validation" novalidate>
          <!-- Login Access Code -->
          <div class="row g-2 align-items-end mb-3">
            <div class="col-md-5">
              <label for="new_password" class="form-label mb-1 small fw-semibold">Login Access Code</label>
              <input type="text" class="form-control form-control-sm" id="new_password" name="new_password"
                     placeholder="Enter new code" minlength="4">
              <div class="text-muted" style="font-size: 0.75rem;">For unlocking the check-in site</div>
            </div>
            <div class="col-md-4">
              <div class="small"><strong>Current:</strong> <code class="bg-light px-2 py-1 rounded">{{ current_password }}</code></div>
            </div>
            <div class="col-md-3">
              <button type="submit" class="btn btn-sm w-100" style="background: {{ branding.primary_color }}; color: white;">
                <i class="bi bi-shield-check"></i> Update
              </button>
            </div>
          </div>
        </form>
        
        <!-- Admin Override Code - Protected (separate form) -->
        <div class="row g-2 align-items-end mt-3" id="override-section">
          <div class="col-12">
            <div class="border rounded p-3 bg-light">
              <div class="d-flex align-items-center justify-content-between mb-2">
                <label class="form-label mb-0 small fw-semibold">
                  <i class="bi bi-lock-fill text-warning"></i> Admin Override Code
                </label>
                {% if override_unlocked %}
                <span class="badge bg-success small">Unlocked</span>
                {% else %}
                <span class="badge bg-warning text-dark small">Protected</span>
                {% endif %}
              </div>
              
              {% if override_unlocked %}
              <!-- Show override code management when unlocked -->
              <form method="POST" class="needs-validation" novalidate>
              <div class="row g-2 align-items-end">
                  <div class="col-md-5">
                    <input type="text" class="form-control form-control-sm" id="new_override_password" name="new_override_password"
                           placeholder="Enter new override code" minlength="4">
                    <div class="text-muted" style="font-size: 0.75rem;">For admin checkout override</div>
                  </div>
                  <div class="col-md-4">
                    <div class="small"><strong>Current:</strong> <code class="bg-white px-2 py-1 rounded border">{{ current_override_password }}</code></div>
                  </div>
                  <div class="col-md-3">
                    <button type="submit" class="btn btn-sm w-100" style="background: {{ branding.primary_color }}; color: white;">
                      <i class="bi bi-shield-check"></i> Update
                    </button>
                  </div>
                </div>
                <div class="mt-2">
                  <a href="{{ url_for('admin_settings') }}" class="btn btn-sm btn-outline-secondary">
                    <i class="bi bi-lock"></i> Lock Override Settings
                  </a>
                </div>
              </form>
              {% else %}
                <!-- Show unlock form when locked -->
                <form method="POST" action="{{ url_for('unlock_override') }}">
                  <div class="row g-2 align-items-end">
                    <div class="col-md-6">
                      <input type="password" class="form-control form-control-sm" name="dev_password" 
                             placeholder="Enter developer password" required autofocus>
                      <div class="text-muted" style="font-size: 0.75rem;">
                        <i class="bi bi-shield-exclamation"></i> Developer password required to view/edit
                      </div>
                    </div>
                    <div class="col-md-3">
                      <button type="submit" class="btn btn-sm btn-warning w-100">
                        <i class="bi bi-unlock"></i> Unlock
                      </button>
                    </div>
                  </div>
                </form>
                {% endif %}
              </div>
            </div>
          </div>
          
          <div class="text-muted small mt-2"><i class="bi bi-info-circle"></i> Min 4 chars each. {% if dev_password_set %}Developer password works for both.{% endif %}</div>
        </form>
      </div>
    </div>

    <!-- Checkout Codes Card -->
    <div class="card shadow-sm mb-3">
      <div class="card-header py-2" style="background: linear-gradient(135deg, {{ branding.accent_color }} 0%, #5a6c38 100%); color: white;">
        <h6 class="mb-0"><i class="bi bi-qr-code"></i> Checkout Codes & Printing</h6>
      </div>
      <div class="card-body p-3">
        <form method="POST">
          <div class="row g-3">
            <!-- Require Codes Toggle -->
            <div class="col-12">
              <div class="form-check form-switch">
                <input type="checkbox" class="form-check-input" id="require_checkout_code" name="require_checkout_code"
                       {% if label_settings.require_checkout_code == 'true' %}checked{% endif %} style="cursor: pointer;">
                <label class="form-check-label fw-semibold" for="require_checkout_code" style="cursor: pointer;">
                  Require checkout codes
                </label>
                <div class="text-muted small">One 5-digit code per family. Admins can override with password.</div>
              </div>
            </div>

            <!-- Code Delivery Method -->
            <div class="col-md-6" id="code-method-section" style="{% if label_settings.require_checkout_code != 'true' %}opacity: 0.5; pointer-events: none;{% endif %}">
              <label for="checkout_code_method" class="form-label small fw-semibold mb-1">Code Delivery</label>
              <select class="form-select form-select-sm" id="checkout_code_method" name="checkout_code_method">
                <option value="qr" {% if label_settings.checkout_code_method == 'qr' or not label_settings.checkout_code_method %}selected{% endif %}>üì± QR Code (Free)</option>
                <option value="label" {% if label_settings.checkout_code_method == 'label' %}selected{% endif %}>üñ®Ô∏è Print Labels</option>
                <option value="both" {% if label_settings.checkout_code_method == 'both' %}selected{% endif %}>üì±üñ®Ô∏è Both</option>
              </select>
            </div>

            <!-- Printer Settings -->
            <div id="printer-settings" style="{% if label_settings.checkout_code_method == 'qr' %}display: none;{% endif %}">
              <div class="col-md-3">
                <label for="label_printer_type" class="form-label small fw-semibold mb-1">Printer</label>
                <select class="form-select form-select-sm" id="label_printer_type" name="label_printer_type">
                  <option value="dymo" {% if label_settings.label_printer_type == 'dymo' or not label_settings.label_printer_type %}selected{% endif %}>DYMO</option>
                  <option value="brother" {% if label_settings.label_printer_type == 'brother' %}selected{% endif %}>Brother QL</option>
                </select>
              </div>

              <div class="col-md-3">
                <label for="label_size" class="form-label small fw-semibold mb-1">Label Size</label>
                <select class="form-select form-select-sm" id="label_size" name="label_size">
                  <optgroup label="Portrait">
                    <option value="30336" {% if label_settings.label_size == '30336' or not label_settings.label_size %}selected{% endif %}>30336 (1√ó2‚Öõ")</option>
                  </optgroup>
                  <optgroup label="Small Landscape">
                    <option value="30330" {% if label_settings.label_size == '30330' %}selected{% endif %}>30330 (¬æ√ó2")</option>
                    <option value="11352" {% if label_settings.label_size == '11352' %}selected{% endif %}>11352 (‚Öû√ó2¬æ")</option>
                  </optgroup>
                  <optgroup label="Medium Landscape">
                    <option value="30334" {% if label_settings.label_size == '30334' %}selected{% endif %}>30334 (2¬º√ó1¬º")</option>
                    <option value="30252" {% if label_settings.label_size == '30252' %}selected{% endif %}>30252 (1‚Öõ√ó3¬Ω")</option>
                  </optgroup>
                  <optgroup label="Large Landscape">
                    <option value="30323" {% if label_settings.label_size == '30323' %}selected{% endif %}>30323 (2‚Öõ√ó4")</option>
                  </optgroup>
                </select>
              </div>
            </div>

            <!-- Info Box -->
            <div class="col-12">
              <div class="alert alert-info p-2 mb-0 small">
                <i class="bi bi-info-circle"></i> <strong>QR:</strong> Parent scans to view/share code. <strong>Labels:</strong> Auto-prints on check-in. <strong>Both:</strong> Show QR + print.
              </div>
            </div>

            <!-- Submit Button -->
            <div class="col-12">
              <button type="submit" class="btn btn-sm" style="background: {{ branding.accent_color }}; color: white;">
                <i class="bi bi-check-circle"></i> Update Checkout Settings
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>

<script>
  // Toggle printer settings visibility based on method
  document.getElementById('checkout_code_method').addEventListener('change', function() {
    const printerSettings = document.getElementById('printer-settings');
    const value = this.value;
    printerSettings.style.display = (value === 'label' || value === 'both') ? 'block' : 'none';
  });
  
  // Enable/disable method section based on require codes checkbox
  document.getElementById('require_checkout_code').addEventListener('change', function() {
    const methodSection = document.getElementById('code-method-section');
    if (this.checked) {
      methodSection.style.opacity = '1';
      methodSection.style.pointerEvents = 'auto';
    } else {
      methodSection.style.opacity = '0.5';
      methodSection.style.pointerEvents = 'none';
    }
  });
</script>


    <!-- Branding & Logo -->
    <div class="card shadow-sm mb-3">
      <div class="card-header py-2" style="background: linear-gradient(135deg, {{ branding.secondary_color }} 0%, {{ branding.secondary_color }} 100%); color: white;">
        <h6 class="mb-0"><i class="bi bi-palette"></i> Branding & Customization</h6>
      </div>
      <div class="card-body p-3">
        <!-- Organization Settings -->
        <form method="POST" class="mb-4">
          <h6 class="mb-3 pb-2 border-bottom small fw-bold text-muted">Organization</h6>
          <div class="row g-3">
            <div class="col-md-8">
              <label for="organization_name" class="form-label small fw-semibold mb-1">Organization Name</label>
              <input type="text" class="form-control form-control-sm" id="organization_name" name="organization_name" 
                     value="{{ branding.organization_name }}" placeholder="e.g., First Baptist Church">
            </div>
            <div class="col-md-4">
              <label for="organization_type" class="form-label small fw-semibold mb-1">Type</label>
              <select class="form-select form-select-sm" id="organization_type" name="organization_type">
                <option value="church" {% if branding.organization_type == 'church' %}selected{% endif %}>Church</option>
                <option value="youth_group" {% if branding.organization_type == 'youth_group' %}selected{% endif %}>Youth Group</option>
                <option value="sports_team" {% if branding.organization_type == 'sports_team' %}selected{% endif %}>Sports Team</option>
                <option value="school" {% if branding.organization_type == 'school' %}selected{% endif %}>School</option>
                <option value="daycare" {% if branding.organization_type == 'daycare' %}selected{% endif %}>Daycare</option>
                <option value="other" {% if branding.organization_type == 'other' %}selected{% endif %}>Other</option>
              </select>
            </div>
            <div class="col-md-4">
              <label for="group_term" class="form-label small fw-semibold mb-1">Group Term</label>
              <input type="text" class="form-control form-control-sm" id="group_term" name="group_term" 
                     value="{{ branding.group_term }}" placeholder="e.g., Troop, Class, Team">
              <div class="text-muted" style="font-size: 0.7rem;">What you call groups</div>
            </div>
          </div>
          
          <h6 class="mb-3 pb-2 border-bottom small fw-bold text-muted mt-4">Colors</h6>
          <div class="row g-3 align-items-end">
            <div class="col-md-4">
              <label for="primary_color" class="form-label small fw-semibold mb-1">Primary Color</label>
              <div class="d-flex gap-2">
                <input type="color" class="form-control form-control-color" id="primary_color" name="primary_color" 
                       value="{{ branding.primary_color }}" title="Choose primary color">
                <input type="text" class="form-control form-control-sm" value="{{ branding.primary_color }}" 
                       style="font-family: monospace; font-size: 0.85rem;" readonly>
              </div>
              <div class="text-muted" style="font-size: 0.7rem;">Main brand color</div>
            </div>
            <div class="col-md-4">
              <label for="secondary_color" class="form-label small fw-semibold mb-1">Secondary Color</label>
              <div class="d-flex gap-2">
                <input type="color" class="form-control form-control-color" id="secondary_color" name="secondary_color" 
                       value="{{ branding.secondary_color }}" title="Choose secondary color">
                <input type="text" class="form-control form-control-sm" value="{{ branding.secondary_color }}" 
                       style="font-family: monospace; font-size: 0.85rem;" readonly>
              </div>
              <div class="text-muted" style="font-size: 0.7rem;">Accent/hover color</div>
            </div>
            <div class="col-md-4">
              <label for="accent_color" class="form-label small fw-semibold mb-1">Accent Color</label>
              <div class="d-flex gap-2">
                <input type="color" class="form-control form-control-color" id="accent_color" name="accent_color" 
                       value="{{ branding.accent_color }}" title="Choose accent color">
                <input type="text" class="form-control form-control-sm" value="{{ branding.accent_color }}" 
                       style="font-family: monospace; font-size: 0.85rem;" readonly>
              </div>
              <div class="text-muted" style="font-size: 0.7rem;">Additional accent</div>
            </div>
            <div class="col-12">
              <div class="alert alert-info p-2 mb-0 small">
                <i class="bi bi-palette"></i> Colors affect buttons, headers, and overall theme throughout the system
              </div>
            </div>
            <div class="col-12">
              <button type="submit" name="action" value="update_branding" class="btn btn-sm" 
                      style="background: {{ branding.primary_color }}; color: white;">
                <i class="bi bi-check-circle"></i> Update Organization & Colors
              </button>
            </div>
          </div>
        </form>
        
        <!-- Logo Upload -->
        <form method="POST" enctype="multipart/form-data">
          <h6 class="mb-3 pb-2 border-bottom small fw-bold text-muted">Logo</h6>
          <div class="row g-3">
            {% if current_logo %}
            <div class="col-md-4">
              <label class="form-label small fw-semibold mb-1">Current Logo</label>
              <div class="border rounded p-2 text-center bg-light">
                <img src="{{ url_for('static', filename='uploads/' + current_logo) }}" alt="Logo" style="max-height: 80px; max-width: 100%;">
              </div>
            </div>
            <div class="col-md-8">
            {% else %}
            <div class="col-12">
            {% endif %}
              <label for="logo_file" class="form-label small fw-semibold mb-1">
                {% if current_logo %}Replace Logo{% else %}Upload Logo{% endif %}
              </label>
              <input type="file" class="form-control form-control-sm" id="logo_file" name="logo_file" accept="image/png,image/jpeg,image/jpg,image/svg+xml">
              <div class="text-muted small mt-1">PNG, JPG, or SVG ‚Ä¢ Max 200px height</div>
              <div class="mt-2">
                <button type="submit" name="action" value="upload_logo" class="btn btn-sm" style="background: {{ branding.secondary_color }}; color: white;">
                  <i class="bi bi-{% if current_logo %}arrow-repeat{% else %}upload{% endif %}"></i> {% if current_logo %}Replace{% else %}Upload{% endif %}
                </button>
                {% if current_logo %}
                <button type="submit" name="action" value="remove_logo" class="btn btn-sm btn-outline-danger" onclick="return confirm('Remove logo?');">
                  <i class="bi bi-trash"></i> Remove
                </button>
                {% endif %}
              </div>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Right Sidebar -->
  <div class="col-lg-4">
    <div class="card shadow-sm mb-3">
      <div class="card-header py-2 bg-light">
        <h6 class="mb-0 small fw-semibold"><i class="bi bi-lightbulb"></i> Tips</h6>
      </div>
      <div class="card-body p-3">
        <ul class="mb-0 ps-3 small lh-sm" style="font-size: 0.85rem;">
          <li class="mb-2">Choose memorable access codes</li>
          <li class="mb-2">Share codes only with authorized staff</li>
          <li class="mb-2">Change codes periodically for security</li>
          <li class="mb-2">QR codes auto-expire after 24 hours</li>
          <li>Labels print automatically on check-in</li>
        </ul>
      </div>
    </div>

    {% if dev_password_set %}
    <div class="alert alert-warning p-2 mb-3 small">
      <i class="bi bi-shield-check"></i> <strong>Developer Access:</strong> Hard-coded backup password is active.
    </div>
    {% endif %}
  </div>
</div>

<script>
// Sync color pickers with hex text inputs
['primary_color', 'secondary_color', 'accent_color'].forEach(id => {
  const colorInput = document.getElementById(id);
  const textInput = colorInput.nextElementSibling;
  
  colorInput.addEventListener('input', function() {
    textInput.value = this.value;
  });
  
  textInput.addEventListener('input', function() {
    if (/^#[0-9A-F]{6}$/i.test(this.value)) {
      colorInput.value = this.value;
    }
  });
});
</script>

</div>
{% endblock %}
