{% extends 'base.html' %}
{% block content %}
<div class="container-fluid">
  <div class="row mb-4">
    <div class="col-12">
      <h2 class="mb-2"><strong>Settings</strong></h2>
      <p class="text-muted">Configure your check-in system, security, and branding</p>
    </div>
  </div>

<div class="row">
  <div class="col-lg-9 col-12">
    <div class="card">
      <div class="card-header" style="background-color: #79060d; color: white;">
        <strong>Security Settings</strong>
      </div>
      <div class="card-body">
        <h5 class="mb-3">Change Access Code</h5>
        <p class="text-muted mb-4">Set the access code that users must enter to unlock the check-in system.</p>

        <form method="POST">
          <div class="mb-3">
            <label for="new_password" class="form-label fw-bold">New Access Code</label>
            <input type="text" class="form-control" id="new_password" name="new_password" required
                   placeholder="Enter new access code" minlength="4">
            <small class="text-muted">Minimum 4 characters. Make it memorable for your team.</small>
          </div>

          <div class="alert alert-info">
            <strong>Current Access Code:</strong> <code>{{ current_password }}</code>
          </div>

          <button type="submit" class="btn btn-lg" style="background-color: #79060d; color: white; border: none;">
            Update Access Code
          </button>
        </form>
      </div>
    </div>

    <div class="card mt-3">
      <div class="card-header" style="background-color: #4a582d; color: white;">
        <strong>Label Printing & Checkout Codes</strong>
      </div>
      <div class="card-body">
        <h5 class="mb-3">Checkout Code Settings</h5>
        <p class="text-muted mb-4">Control whether checkout codes are required and how parents receive them.</p>

        <form method="POST">
          <div class="mb-4">
            <div class="form-check form-switch" style="font-size: 1.1rem;">
              <input type="checkbox" class="form-check-input" id="require_checkout_code" name="require_checkout_code"
                     {% if label_settings.require_checkout_code == 'true' %}checked{% endif %}
                     style="width: 3em; height: 1.5em;">
              <label class="form-check-label" for="require_checkout_code">
                <strong>Require checkout codes</strong>
              </label>
            </div>
            <div class="form-text ms-5">When enabled, parents must enter a code to check out their child. One code is generated per family check-in.</div>
          </div>

          <div id="code-method-section" style="{% if label_settings.require_checkout_code != 'true' %}opacity: 0.5; pointer-events: none;{% endif %}">
            <div class="mb-3">
              <label for="checkout_code_method" class="form-label"><strong>How should parents receive the checkout code?</strong></label>
              <select class="form-select" id="checkout_code_method" name="checkout_code_method">
                <option value="qr" {% if label_settings.checkout_code_method == 'qr' or not label_settings.checkout_code_method %}selected{% endif %}>üì± QR Code - Scan with phone (Free)</option>
                <option value="label" {% if label_settings.checkout_code_method == 'label' %}selected{% endif %}>üñ®Ô∏è Print Labels - Physical printout</option>
                <option value="both" {% if label_settings.checkout_code_method == 'both' %}selected{% endif %}>üì±üñ®Ô∏è Both QR Code and Print</option>
              </select>
              <div class="form-text">
                <strong>QR Code:</strong> Parent scans QR code with phone camera to view code and share via text/email/any app.<br>
                <strong>Print Labels:</strong> Code prints automatically on label printer (requires label printer hardware).<br>
                <strong>Both:</strong> Show QR code on screen and print labels simultaneously.
              </div>
            </div>

          <div id="printer-settings" style="{% if label_settings.checkout_code_method == 'qr' %}display: none;{% endif %}">
            <div class="mb-3">
              <label for="label_printer_type" class="form-label">Printer Type</label>
              <select class="form-select" id="label_printer_type" name="label_printer_type">
                <option value="dymo" {% if label_settings.label_printer_type == 'dymo' or not label_settings.label_printer_type %}selected{% endif %}>DYMO Label Printer</option>
                <option value="brother" {% if label_settings.label_printer_type == 'brother' %}selected{% endif %}>Brother QL Series</option>
              </select>
            </div>

          <div class="row">
            <div class="col-6">
              <div class="mb-3">
                <label for="label_width" class="form-label">Label Width (inches)</label>
                <input type="number" step="0.1" class="form-control" id="label_width" name="label_width" 
                       value="{{ label_settings.label_width or '2.0' }}">
              </div>
            </div>
            <div class="col-6">
              <div class="mb-3">
                <label for="label_height" class="form-label">Label Height (inches)</label>
                <input type="number" step="0.1" class="form-control" id="label_height" name="label_height" 
                       value="{{ label_settings.label_height or '1.0' }}">
              </div>
            </div>
          </div>

          <div class="alert alert-info">
            <strong>How it works:</strong>
            <ul class="mb-0 small">
              <li>When checking in, <strong>one unique 5-digit code is generated per family</strong> (even if checking in multiple siblings)</li>
              <li><strong>QR Code:</strong> Parent scans QR code with phone to view all kids and the checkout code, then shares via text/email/any app</li>
              <li><strong>Labels:</strong> Code prints on label for each child (all show same family code)</li>
              <li>To check out any child, parent enters the same family code</li>
              <li>Admins can override with the app password</li>
            </ul>
          </div>

          <button type="submit" class="btn btn-lg" style="background-color: #4a582d; color: white; border: none;">
            Update Checkout Settings
          </button>
        </form>

        <script>
          // Toggle printer settings visibility based on method
          document.getElementById('checkout_code_method').addEventListener('change', function() {
            const printerSettings = document.getElementById('printer-settings');
            const value = this.value;
            printerSettings.style.display = (value === 'label' || value === 'both') ? 'block' : 'none';
          });
          
          // Enable/disable method section based on require codes checkbox
          document.getElementById('require_checkout_code').addEventListener('change', function() {
            const methodSection = document.getElementById('code-method-section');
            if (this.checked) {
              methodSection.style.opacity = '1';
              methodSection.style.pointerEvents = 'auto';
            } else {
              methodSection.style.opacity = '0.5';
              methodSection.style.pointerEvents = 'none';
            }
          });
        </script>
      </div>
      </div>
    </div>


    <!-- Branding & Logo -->
    <div class="card mt-3">
      <div class="card-header" style="background-color: #003b59; color: white;">
        <strong>üé® Branding & Logo</strong>
      </div>
      <div class="card-body">
        <p class="text-muted mb-3">Upload your troop logo to display on checkout pages and the kiosk.</p>

        <form method="POST" enctype="multipart/form-data">
          {% if current_logo %}
          <div class="mb-3">
            <label class="form-label fw-bold">Current Logo</label>
            <div class="border rounded p-3 bg-light text-center">
              <img src="{{ url_for('static', filename='uploads/' + current_logo) }}" alt="Current Logo" style="max-height: 120px; max-width: 100%;">
            </div>
          </div>
          {% endif %}

          <div class="mb-3">
            <label for="logo_file" class="form-label fw-bold">{% if current_logo %}Replace{% else %}Upload{% endif %} Logo</label>
            <input type="file" class="form-control" id="logo_file" name="logo_file" accept="image/png,image/jpeg,image/jpg,image/svg+xml">
            <small class="text-muted">PNG, JPG, or SVG ‚Ä¢ Recommended: transparent PNG, max 200px height</small>
          </div>

          <div class="d-flex gap-2">
            <button type="submit" name="action" value="upload_logo" class="btn btn-lg" style="background-color: #003b59; color: white; border: none;">
              {% if current_logo %}Replace Logo{% else %}Upload Logo{% endif %}
            </button>
            {% if current_logo %}
            <button type="submit" name="action" value="remove_logo" class="btn btn-outline-danger" onclick="return confirm('Remove current logo?');">
              Remove
            </button>
            {% endif %}
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Sidebar -->
  <div class="col-lg-3 col-12 mt-3 mt-lg-0">
    <!-- Quick Actions -->
    <div class="card">
      <div class="card-header" style="background-color: #4a582d; color: white;">
        <strong>Quick Actions</strong>
      </div>
      <div class="card-body">
        <div class="d-grid gap-2">
          <a href="{{ url_for('admin_index') }}" class="btn btn-outline-secondary">
            ‚Üê Back to Admin
          </a>
          <a href="{{ url_for('logout') }}" class="btn btn-outline-danger">
            üîí Logout
          </a>
        </div>
      </div>
    </div>

    <!-- Info Cards -->
    <div class="card mt-3">
      <div class="card-header" style="background-color: #f8f9fa; border-bottom: 2px solid #dee2e6;">
        <strong>üí° Security Tips</strong>
      </div>
      <div class="card-body">
        <ul class="small mb-0 ps-3">
          <li class="mb-2">Choose a memorable but secure access code</li>
          <li class="mb-2">Share codes only with authorized team members</li>
          <li class="mb-2">Change the access code periodically</li>
          <li>Developer password provides backup access</li>
        </ul>
      </div>
    </div>

    <div class="card mt-3">
      <div class="card-header" style="background-color: #f8f9fa; border-bottom: 2px solid #dee2e6;">
        <strong>üîÑ Data Cleanup</strong>
      </div>
      <div class="card-body">
        <p class="small mb-0">Checkout code links are automatically deleted after 24 hours or when kids are checked out. Your server stays clean - no manual cleanup needed!</p>
      </div>
    </div>

    {% if dev_password_set %}
    <div class="card mt-3 border-warning">
      <div class="card-header bg-warning text-dark">
        <strong>üõ°Ô∏è Developer Access</strong>
      </div>
      <div class="card-body">
        <p class="small mb-0">A hard-coded developer password provides backup admin access if the access code is lost.</p>
      </div>
    </div>
    {% endif %}
  </div>
</div>
</div>
{% endblock %}
