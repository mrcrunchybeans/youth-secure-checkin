{% extends 'base.html' %}
{% block content %}
<div class="container-fluid py-4">
  <!-- Page Header -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
        <div>
          <h1 class="mb-2" style="color: #79060d; font-weight: 700;">‚öôÔ∏è Settings</h1>
          <p class="text-muted mb-0" style="font-size: 1.05rem;">Configure your check-in system, security, and branding</p>
        </div>
        <div class="d-flex gap-2">
          <a href="{{ url_for('admin_index') }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Back to Admin
          </a>
          <a href="{{ url_for('logout') }}" class="btn btn-outline-danger">
            <i class="bi bi-lock"></i> Logout
          </a>
        </div>
      </div>
    </div>
  </div>

<div class="row">
  <div class="col-lg-9 col-12">
    <!-- Security Settings Card -->
    <div class="card shadow-sm mb-4">
      <div class="card-header" style="background: linear-gradient(135deg, #79060d 0%, #8d0710 100%); color: white; padding: 1.25rem;">
        <h5 class="mb-0" style="font-weight: 600;"><i class="bi bi-shield-lock"></i> Security Settings</h5>
      </div>
      <div class="card-body" style="padding: 1.5rem;">
        <h5 class="mb-2" style="color: #79060d; font-weight: 600;">Change Access Code</h5>
        <p class="text-muted mb-4" style="font-size: 0.95rem;">Set the access code that users must enter to unlock the check-in system.</p>

        <form method="POST" class="needs-validation" novalidate>
          <div class="mb-4">
            <label for="new_password" class="form-label" style="font-weight: 600; color: #333;">New Access Code</label>
            <input type="text" class="form-control form-control-lg" id="new_password" name="new_password" required
                   placeholder="Enter new access code" minlength="4" style="border: 2px solid #dee2e6;">
            <div class="form-text"><i class="bi bi-info-circle"></i> Minimum 4 characters. Make it memorable for your team.</div>
          </div>

          <div class="alert" style="background-color: #f8f9fa; border-left: 4px solid #79060d; border-radius: 8px;">
            <div class="d-flex align-items-center gap-2">
              <i class="bi bi-key-fill" style="color: #79060d; font-size: 1.3rem;"></i>
              <div>
                <strong style="color: #79060d;">Current Access Code:</strong> 
                <code style="background-color: white; padding: 0.3rem 0.6rem; border-radius: 4px; font-size: 1.1rem;">{{ current_password }}</code>
              </div>
            </div>
          </div>

          <button type="submit" class="btn btn-lg px-4" style="background: linear-gradient(135deg, #79060d 0%, #8d0710 100%); color: white; border: none; font-weight: 600; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <i class="bi bi-shield-check"></i> Update Access Code
          </button>
        </form>
      </div>
    </div>

    <!-- Checkout Codes Card -->
    <div class="card shadow-sm mb-4">
      <div class="card-header" style="background: linear-gradient(135deg, #4a582d 0%, #5a6c38 100%); color: white; padding: 1.25rem;">
        <h5 class="mb-0" style="font-weight: 600;"><i class="bi bi-qr-code"></i> Label Printing & Checkout Codes</h5>
      </div>
      <div class="card-body" style="padding: 1.5rem;">
        <h5 class="mb-2" style="color: #4a582d; font-weight: 600;">Checkout Code Settings</h5>
        <p class="text-muted mb-4" style="font-size: 0.95rem;">Control whether checkout codes are required and how parents receive them.</p>

        <form method="POST">
          <div class="mb-4 p-3" style="background-color: #f8f9fa; border-radius: 8px; border: 2px solid #dee2e6;">
            <div class="form-check form-switch" style="font-size: 1.15rem;">
              <input type="checkbox" class="form-check-input" id="require_checkout_code" name="require_checkout_code"
                     {% if label_settings.require_checkout_code == 'true' %}checked{% endif %}
                     style="width: 3.5em; height: 1.75em; cursor: pointer;">
              <label class="form-check-label" for="require_checkout_code" style="cursor: pointer; font-weight: 600; color: #333;">
                Require checkout codes
              </label>
            </div>
            <div class="form-text ms-5 mt-2"><i class="bi bi-info-circle"></i> When enabled, parents must enter a code to check out their child. One code is generated per family check-in.</div>
          </div>

          <div id="code-method-section" style="{% if label_settings.require_checkout_code != 'true' %}opacity: 0.5; pointer-events: none;{% endif %}">
            <div class="mb-4">
              <label for="checkout_code_method" class="form-label" style="font-weight: 600; color: #333;">How should parents receive the checkout code?</label>
              <select class="form-select form-select-lg" id="checkout_code_method" name="checkout_code_method" style="border: 2px solid #dee2e6;">
                <option value="qr" {% if label_settings.checkout_code_method == 'qr' or not label_settings.checkout_code_method %}selected{% endif %}>üì± QR Code - Scan with phone (Free)</option>
                <option value="label" {% if label_settings.checkout_code_method == 'label' %}selected{% endif %}>üñ®Ô∏è Print Labels - Physical printout</option>
                <option value="both" {% if label_settings.checkout_code_method == 'both' %}selected{% endif %}>üì±üñ®Ô∏è Both QR Code and Print</option>
              </select>
              <div class="form-text mt-2" style="font-size: 0.9rem;">
                <div class="mb-1"><i class="bi bi-phone"></i> <strong>QR Code:</strong> Parent scans QR code with phone camera to view code and share via text/email/any app.</div>
                <div class="mb-1"><i class="bi bi-printer"></i> <strong>Print Labels:</strong> Code prints automatically on label printer (requires label printer hardware).</div>
                <div><i class="bi bi-collection"></i> <strong>Both:</strong> Show QR code on screen and print labels simultaneously.</div>
              </div>
            </div>

          <div id="printer-settings" style="{% if label_settings.checkout_code_method == 'qr' %}display: none;{% endif %}">
            <div class="mb-4">
              <label for="label_printer_type" class="form-label" style="font-weight: 600; color: #333;">Printer Type</label>
              <select class="form-select form-select-lg" id="label_printer_type" name="label_printer_type" style="border: 2px solid #dee2e6;">
                <option value="dymo" {% if label_settings.label_printer_type == 'dymo' or not label_settings.label_printer_type %}selected{% endif %}>DYMO Label Printer</option>
                <option value="brother" {% if label_settings.label_printer_type == 'brother' %}selected{% endif %}>Brother QL Series</option>
              </select>
            </div>

          <div class="mb-3">
            <label for="label_size" class="form-label" style="font-weight: 600; color: #333;">Label Size</label>
            <select class="form-select form-select-lg" id="label_size" name="label_size" style="border: 2px solid #dee2e6;">
              <optgroup label="Small Labels (Portrait)">
                <option value="30336" {% if label_settings.label_size == '30336' or not label_settings.label_size %}selected{% endif %}>Dymo 30336 - 1" √ó 2‚Öõ"</option>
              </optgroup>
              <optgroup label="Small Labels (Landscape)">
                <option value="30330" {% if label_settings.label_size == '30330' %}selected{% endif %}>Dymo 30330 - ¬æ" √ó 2"</option>
                <option value="11352" {% if label_settings.label_size == '11352' %}selected{% endif %}>Dymo 11352 - ‚Öû" √ó 2¬æ"</option>
              </optgroup>
              <optgroup label="Medium Labels (Landscape)">
                <option value="30334" {% if label_settings.label_size == '30334' %}selected{% endif %}>Dymo 30334 - 2¬º" √ó 1¬º"</option>
                <option value="30252" {% if label_settings.label_size == '30252' %}selected{% endif %}>Dymo 30252 - 1‚Öõ" √ó 3¬Ω" (Address)</option>
              </optgroup>
              <optgroup label="Large Labels (Landscape)">
                <option value="30323" {% if label_settings.label_size == '30323' %}selected{% endif %}>Dymo 30323 - 2‚Öõ" √ó 4" (Shipping)</option>
              </optgroup>
            </select>
            <div class="form-text" style="font-size: 0.9rem;">
              Select the Dymo label size you're using. The label layout will automatically adjust.
            </div>
          </div>
          </div>

          <div class="alert" style="background-color: #e7f3ff; border-left: 4px solid #4a582d; border-radius: 8px;">
            <div class="d-flex gap-2">
              <i class="bi bi-info-circle-fill" style="color: #4a582d; font-size: 1.3rem; margin-top: 2px;"></i>
              <div>
                <strong style="color: #4a582d;">How it works:</strong>
                <ul class="mb-0 mt-2" style="font-size: 0.95rem; line-height: 1.6;">
                  <li>When checking in, <strong>one unique 5-digit code is generated per family</strong> (even if checking in multiple siblings)</li>
                  <li><strong>QR Code:</strong> Parent scans QR code with phone to view all kids and the checkout code, then shares via text/email/any app</li>
                  <li><strong>Labels:</strong> Code prints on label for each child (all show same family code)</li>
                  <li>To check out any child, parent enters the same family code</li>
                  <li>Admins can override with the app password</li>
                </ul>
              </div>
            </div>
          </div>

          <button type="submit" class="btn btn-lg px-4" style="background: linear-gradient(135deg, #4a582d 0%, #5a6c38 100%); color: white; border: none; font-weight: 600; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <i class="bi bi-check-circle"></i> Update Checkout Settings
          </button>
        </form>

      </div>
    </div>

<script>
  // Toggle printer settings visibility based on method
  document.getElementById('checkout_code_method').addEventListener('change', function() {
    const printerSettings = document.getElementById('printer-settings');
    const value = this.value;
    printerSettings.style.display = (value === 'label' || value === 'both') ? 'block' : 'none';
  });
  
  // Enable/disable method section based on require codes checkbox
  document.getElementById('require_checkout_code').addEventListener('change', function() {
    const methodSection = document.getElementById('code-method-section');
    if (this.checked) {
      methodSection.style.opacity = '1';
      methodSection.style.pointerEvents = 'auto';
    } else {
      methodSection.style.opacity = '0.5';
      methodSection.style.pointerEvents = 'none';
    }
  });
</script>


    <!-- Branding & Logo -->
    <div class="card shadow-sm mb-4">
      <div class="card-header" style="background: linear-gradient(135deg, #003b59 0%, #004a6e 100%); color: white; padding: 1.25rem;">
        <h5 class="mb-0" style="font-weight: 600;"><i class="bi bi-palette"></i> Branding & Logo</h5>
      </div>
      <div class="card-body" style="padding: 1.5rem;">
        <p class="text-muted mb-4" style="font-size: 0.95rem;">Upload your troop logo to display on checkout pages and the kiosk.</p>

        <form method="POST" enctype="multipart/form-data">
          {% if current_logo %}
          <div class="mb-4">
            <label class="form-label" style="font-weight: 600; color: #333;">Current Logo</label>
            <div class="border rounded p-4 text-center" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border: 2px solid #dee2e6 !important;">
              <img src="{{ url_for('static', filename='uploads/' + current_logo) }}" alt="Current Logo" style="max-height: 120px; max-width: 100%; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));">
            </div>
          </div>
          {% endif %}

          <div class="mb-4">
            <label for="logo_file" class="form-label" style="font-weight: 600; color: #333;">
              {% if current_logo %}<i class="bi bi-arrow-repeat"></i> Replace Logo{% else %}<i class="bi bi-upload"></i> Upload Logo{% endif %}
            </label>
            <input type="file" class="form-control form-control-lg" id="logo_file" name="logo_file" accept="image/png,image/jpeg,image/jpg,image/svg+xml" style="border: 2px solid #dee2e6;">
            <div class="form-text mt-2"><i class="bi bi-info-circle"></i> PNG, JPG, or SVG ‚Ä¢ Recommended: transparent PNG, max 200px height</div>
          </div>

          <div class="d-flex gap-2 flex-wrap">
            <button type="submit" name="action" value="upload_logo" class="btn btn-lg px-4" style="background: linear-gradient(135deg, #003b59 0%, #004a6e 100%); color: white; border: none; font-weight: 600; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
              <i class="bi bi-{% if current_logo %}arrow-repeat{% else %}upload{% endif %}"></i> {% if current_logo %}Replace Logo{% else %}Upload Logo{% endif %}
            </button>
            {% if current_logo %}
            <button type="submit" name="action" value="remove_logo" class="btn btn-outline-danger btn-lg px-4" onclick="return confirm('Remove current logo?');" style="font-weight: 600;">
              <i class="bi bi-trash"></i> Remove
            </button>
            {% endif %}
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Sidebar -->
  <div class="col-lg-3 col-12 mt-4 mt-lg-0">
    <!-- Info Cards -->
    <div class="card shadow-sm mb-3" style="border: 2px solid #f8f9fa;">
      <div class="card-header" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-bottom: 2px solid #dee2e6; padding: 1rem;">
        <h6 class="mb-0" style="font-weight: 600; color: #333;"><i class="bi bi-lightbulb"></i> Security Tips</h6>
      </div>
      <div class="card-body" style="padding: 1rem;">
        <ul class="mb-0 ps-3" style="font-size: 0.9rem; line-height: 1.7;">
          <li class="mb-2">Choose a memorable but secure access code</li>
          <li class="mb-2">Share codes only with authorized team members</li>
          <li class="mb-2">Change the access code periodically</li>
          <li>Developer password provides backup access</li>
        </ul>
      </div>
    </div>

    <div class="card shadow-sm mb-3" style="border: 2px solid #e7f3ff;">
      <div class="card-header" style="background: linear-gradient(135deg, #e7f3ff 0%, #d4e9ff 100%); border-bottom: 2px solid #4a582d; padding: 1rem;">
        <h6 class="mb-0" style="font-weight: 600; color: #333;"><i class="bi bi-arrow-repeat"></i> Data Cleanup</h6>
      </div>
      <div class="card-body" style="padding: 1rem;">
        <p class="mb-0" style="font-size: 0.9rem; line-height: 1.6;">Checkout code links are automatically deleted after 24 hours or when kids are checked out. Your server stays clean - no manual cleanup needed!</p>
      </div>
    </div>

    {% if dev_password_set %}
    <div class="card shadow-sm mb-3" style="border: 2px solid #ffc107;">
      <div class="card-header" style="background: linear-gradient(135deg, #fff3cd 0%, #ffe69c 100%); border-bottom: 2px solid #ffc107; padding: 1rem;">
        <h6 class="mb-0" style="font-weight: 600; color: #856404;"><i class="bi bi-shield-check"></i> Developer Access</h6>
      </div>
      <div class="card-body" style="padding: 1rem;">
        <p class="mb-0" style="font-size: 0.9rem; line-height: 1.6; color: #856404;">A hard-coded developer password provides backup admin access if the access code is lost.</p>
      </div>
    </div>
    {% endif %}
  </div>
</div>
</div>
{% endblock %}
