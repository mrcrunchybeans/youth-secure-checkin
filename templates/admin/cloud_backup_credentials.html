{% extends 'base.html' %}
{% block content %}
<div class="container-fluid py-3">
  <!-- Page Header -->
  <div class="d-flex align-items-center justify-content-between mb-3">
    <div>
      <h2 class="mb-1" style="color: #0dcaf0; font-weight: 700;"><i class="bi bi-shield-lock"></i> Cloud Backup Credentials</h2>
      <p class="text-muted mb-0">Manage OAuth credentials for Google Drive, Dropbox, and OneDrive</p>
    </div>
    <div class="d-flex gap-2">
      <a href="{{ url_for('cloud_backup_settings') }}" class="btn btn-sm btn-outline-secondary"><i class="bi bi-arrow-left"></i> Back</a>
      <a href="{{ url_for('logout') }}" class="btn btn-sm btn-outline-danger"><i class="bi bi-lock"></i> Logout</a>
    </div>
  </div>

  <div class="row">
    <div class="col-lg-8">
      <!-- Security Alert -->
      <div class="alert alert-info mb-3">
        <i class="bi bi-shield-check"></i> <strong>Security Notice:</strong> All credentials are protected by developer password and encrypted in the database.
      </div>

      {% if not dev_password_set %}
        <div class="alert alert-warning mb-3">
          <i class="bi bi-exclamation-triangle"></i> <strong>Warning:</strong> Developer password is not set! Credentials are not protected. Set DEVELOPER_PASSWORD environment variable.
        </div>
      {% endif %}

      <!-- Unlock Section -->
      <div class="card shadow-sm mb-3">
        <div class="card-header py-2" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); color: white;">
          <h6 class="mb-0"><i class="bi bi-lock"></i> Access Control</h6>
        </div>
        <div class="card-body p-3">
          {% if credentials_unlocked %}
            <div class="alert alert-success small mb-3">
              <i class="bi bi-unlock"></i> Credentials are unlocked. You can now view and edit them.
            </div>
            <form method="POST">
              <button type="submit" name="action" value="lock" class="btn btn-sm btn-warning">
                <i class="bi bi-lock"></i> Lock Credentials
              </button>
            </form>
          {% else %}
            <p class="small text-muted mb-3">Enter your developer password to unlock and edit credentials.</p>
            <form method="POST">
              <div class="mb-3">
                <label for="dev_password" class="form-label small fw-semibold">Developer Password</label>
                <div class="input-group input-group-sm">
                  <input type="password" name="dev_password" id="dev_password" class="form-control" placeholder="Enter developer password" required>
                  <button type="submit" name="action" value="unlock" class="btn btn-primary">
                    <i class="bi bi-unlock"></i> Unlock
                  </button>
                </div>
              </div>
            </form>
          {% endif %}
        </div>
      </div>

      <!-- Credentials Form -->
      {% if credentials_unlocked %}
        <form method="POST">
          <!-- Google Drive Credentials -->
          <div class="card shadow-sm mb-3">
            <div class="card-header py-2" style="background: linear-gradient(135deg, #4285F4 0%, #1a73e8 100%); color: white;">
              <h6 class="mb-0"><i class="bi bi-google"></i> Google Drive OAuth Credentials</h6>
            </div>
            <div class="card-body p-3">
              <p class="small text-muted mb-3">
                Get these from <a href="https://console.cloud.google.com" target="_blank">Google Cloud Console</a>
              </p>
              <div class="mb-3">
                <label for="google_oauth_client_id" class="form-label small fw-semibold">Client ID</label>
                <input type="text" name="google_oauth_client_id" id="google_oauth_client_id" class="form-control form-control-sm" 
                       value="{{ credentials.google_oauth_client_id or '' }}" placeholder="xxx.apps.googleusercontent.com">
              </div>
              <div class="mb-3">
                <label for="google_oauth_client_secret" class="form-label small fw-semibold">Client Secret</label>
                <input type="password" name="google_oauth_client_secret" id="google_oauth_client_secret" class="form-control form-control-sm" 
                       value="{{ credentials.google_oauth_client_secret or '' }}" placeholder="Your client secret">
              </div>
              <small class="text-muted d-block">
                <strong>Scopes required:</strong> Google Drive API
              </small>
            </div>
          </div>

          <!-- Dropbox Credentials -->
          <div class="card shadow-sm mb-3">
            <div class="card-header py-2" style="background: linear-gradient(135deg, #0061FF 0%, #003a99 100%); color: white;">
              <h6 class="mb-0"><i class="bi bi-droplet"></i> Dropbox OAuth Credentials</h6>
            </div>
            <div class="card-body p-3">
              <p class="small text-muted mb-3">
                Get these from <a href="https://www.dropbox.com/developers/apps" target="_blank">Dropbox App Console</a>
              </p>
              <div class="mb-3">
                <label for="dropbox_oauth_client_id" class="form-label small fw-semibold">App Key (Client ID)</label>
                <input type="text" name="dropbox_oauth_client_id" id="dropbox_oauth_client_id" class="form-control form-control-sm" 
                       value="{{ credentials.dropbox_oauth_client_id or '' }}" placeholder="Your Dropbox App Key">
              </div>
              <div class="mb-3">
                <label for="dropbox_oauth_client_secret" class="form-label small fw-semibold">App Secret (Client Secret)</label>
                <input type="password" name="dropbox_oauth_client_secret" id="dropbox_oauth_client_secret" class="form-control form-control-sm" 
                       value="{{ credentials.dropbox_oauth_client_secret or '' }}" placeholder="Your Dropbox App Secret">
              </div>
              <small class="text-muted d-block">
                <strong>App type:</strong> Scoped access, Full Dropbox access
              </small>
            </div>
          </div>

          <!-- OneDrive Credentials -->
          <div class="card shadow-sm mb-3">
            <div class="card-header py-2" style="background: linear-gradient(135deg, #0078D4 0%, #004B87 100%); color: white;">
              <h6 class="mb-0"><i class="bi bi-microsoft"></i> OneDrive (Microsoft Azure) OAuth Credentials</h6>
            </div>
            <div class="card-body p-3">
              <p class="small text-muted mb-3">
                Get these from <a href="https://portal.azure.com" target="_blank">Azure Portal</a>
              </p>
              <div class="mb-3">
                <label for="onedrive_oauth_client_id" class="form-label small fw-semibold">Application (Client) ID</label>
                <input type="text" name="onedrive_oauth_client_id" id="onedrive_oauth_client_id" class="form-control form-control-sm" 
                       value="{{ credentials.onedrive_oauth_client_id or '' }}" placeholder="Your Azure Client ID">
              </div>
              <div class="mb-3">
                <label for="onedrive_oauth_client_secret" class="form-label small fw-semibold">Client Secret Value</label>
                <input type="password" name="onedrive_oauth_client_secret" id="onedrive_oauth_client_secret" class="form-control form-control-sm" 
                       value="{{ credentials.onedrive_oauth_client_secret or '' }}" placeholder="Your Azure Client Secret">
              </div>
              <small class="text-muted d-block">
                <strong>Permissions required:</strong> Files.ReadWrite (delegated)
              </small>
            </div>
          </div>

          <!-- Save Button -->
          <div class="d-flex gap-2">
            <button type="submit" name="action" value="save_credentials" class="btn btn-success">
              <i class="bi bi-check-circle"></i> Save Credentials
            </button>
            <a href="{{ url_for('cloud_backup_settings') }}" class="btn btn-secondary">
              <i class="bi bi-x-circle"></i> Cancel
            </a>
          </div>
        </form>
      {% else %}
        <div class="alert alert-warning">
          <i class="bi bi-lock"></i> Credentials are locked. Unlock them above to view and edit.
        </div>
      {% endif %}
    </div>

    <!-- Info Sidebar -->
    <div class="col-lg-4">
      <div class="card shadow-sm mb-3">
        <div class="card-header py-2" style="background: #e7f3ff; color: #0066cc; font-weight: 600;">
          <i class="bi bi-lightbulb"></i> Security Best Practices
        </div>
        <div class="card-body p-3 small">
          <ul class="list-unstyled">
            <li><strong>✓ Never hardcode:</strong> Keep credentials out of code</li>
            <li><strong>✓ Use strong password:</strong> Developer password protects access</li>
            <li><strong>✓ Rotate tokens:</strong> Regenerate OAuth apps periodically</li>
            <li><strong>✓ Limit scopes:</strong> Only use required permissions</li>
            <li><strong>✓ Backup safely:</strong> Database is encrypted at rest (recommended)</li>
          </ul>
        </div>
      </div>

      <div class="card shadow-sm mb-3">
        <div class="card-header py-2" style="background: #e7f3ff; color: #0066cc; font-weight: 600;">
          <i class="bi bi-info-circle"></i> Setup Guide
        </div>
        <div class="card-body p-3 small">
          <p><strong>1. Create OAuth Apps</strong></p>
          <p class="text-muted mb-3">Visit each provider's developer console and create an OAuth app. Note the redirect URIs below.</p>
          
          <p><strong>2. Set Redirect URIs</strong></p>
          <p class="text-muted mb-3">
            Add to each app:
            <br><code>{{ request.url_root }}admin/oauth/google/callback</code>
            <br><code>{{ request.url_root }}admin/oauth/dropbox/callback</code>
            <br><code>{{ request.url_root }}admin/oauth/onedrive/callback</code>
          </p>
          
          <p><strong>3. Enter Credentials</strong></p>
          <p class="text-muted mb-3">Paste Client ID and Client Secret above and save.</p>
          
          <p><strong>4. Connect Services</strong></p>
          <p class="text-muted">Go to Cloud Backup settings and click "Connect" for each service.</p>
        </div>
      </div>

      <div class="alert alert-info small">
        <i class="bi bi-shield-check"></i> <strong>Your data is protected:</strong>
        <ul class="mb-0 mt-2">
          <li>Credentials stored in secure database</li>
          <li>Access requires developer password</li>
          <li>HTTPS/TLS for all OAuth flows</li>
          <li>Tokens never exposed in logs</li>
        </ul>
      </div>
    </div>
  </div>

</div>
{% endblock %}
