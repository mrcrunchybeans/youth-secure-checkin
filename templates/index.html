{% extends 'base.html' %}
{% block content %}
<style>
  @media (max-width: 768px) {
    .card-header {
      padding: 0.5rem 0.75rem;
      font-size: 0.95rem;
    }
    .event-select-mobile {
      max-width: 150px !important;
      font-size: 0.8rem;
    }
    #checkin-form .col-auto {
      width: 100%;
    }
    #checkin-form button {
      width: 100%;
      margin-top: 0.5rem;
    }
    .list-group-item {
      flex-direction: column;
      align-items: flex-start !important;
    }
    .list-group-item form {
      width: 100%;
      margin-top: 0.5rem;
    }
    .list-group-item form button {
      width: 100%;
    }
  }
</style>
<div class="row">
  <div class="col-lg-8 col-12">
    <div class="card mb-3">
      <div class="card-header d-flex justify-content-between align-items-center flex-wrap" style="background-color: #79060d; color: white;">
        <strong class="mb-1 mb-sm-0">Family Lookup</strong>
        <!-- Desktop: dropdown select -->
        <select id="event-select" class="form-select form-select-sm d-none d-sm-inline-block" style="width: auto; max-width: 300px;">
          {% for event in events %}
            <option value="{{ event['id'] }}" {% if event['id'] == current_event_id %}selected{% endif %}>{{ event['start_time'][:10] }} - {{ event['name'] }}</option>
          {% endfor %}
        </select>
        <!-- Mobile: button opens modal -->
        <button type="button" class="btn btn-sm btn-light d-inline d-sm-none" data-bs-toggle="modal" data-bs-target="#eventModalIndex" style="padding: 0.25rem 0.75rem; font-size: 1.2rem;" title="Select Event">
          &#128197;
        </button>
      </div>
      <div class="card-body">
        <form id="checkin-form" class="row g-3 align-items-end">
          <input type="hidden" id="event-id" name="event_id" value="{{ current_event_id }}">
          <div class="col-auto col-md-8" style="flex: 1;">
            <label class="form-label fw-bold">Last 4 Digits of Phone</label>
            <input id="last4" class="form-control" maxlength="4" pattern="\d{4}" required placeholder="0000" inputmode="numeric" />
          </div>
          <div class="col-auto col-md-4">
            <button type="submit" class="btn" style="background-color: #79060d; color: white; border: none; padding: 0.5rem 2rem;">Search</button>
          </div>
        </form>
      </div>
    </div>

    <div class="card">
      <div class="card-header" style="background-color: #4a582d; color: white;"><strong>Currently Checked In - {{ checked_in|length }}</strong></div>
      <ul class="list-group list-group-flush" style="max-height: 500px; overflow-y: auto;">
        {% for row in checked_in %}
          <li class="list-group-item d-flex justify-content-between align-items-center py-2">
            <div style="flex: 1;">
              <div>
                <strong style="font-size: 1.1rem;">{{ row['kid_name'] }}</strong>
                {% if row['kid_notes'] %}
                  <span class="text-muted ms-1" style="cursor: pointer; font-size: 0.7rem; opacity: 0.6;" 
                        data-bs-toggle="tooltip" data-bs-placement="top" data-bs-html="true"
                        title="{{ row['kid_notes'] | replace('\n', '<br>') }}">‚ÑπÔ∏è</span>
                {% endif %}
                {% if row['authorized_adults'] %}
                  <span class="text-muted ms-1" style="cursor: pointer; font-size: 0.7rem; opacity: 0.6;" 
                        data-bs-toggle="tooltip" data-bs-placement="top" data-bs-html="true"
                        title="<strong>Authorized for Checkout:</strong><br>{{ row['authorized_adults'] | replace('\n', '<br>') }}">üë§</span>
                {% endif %}
                <span class="text-muted d-block d-sm-inline">‚Äî {{ row['adult_name'] }}</span>
              </div>
              <small class="text-muted d-block">Phone: {{ row['phone'] }} ¬∑ {{ row['formatted_time'] }}</small>
            </div>
            <button class="btn btn-sm checkout-btn" style="color: #79060d; border-color: #79060d; white-space: nowrap;" 
                    data-kid-id="{{ row['kid_id'] }}" 
                    data-kid-name="{{ row['kid_name'] }}" 
                    data-event-id="{{ current_event_id }}">Check Out</button>
          </li>
        {% else %}
          <li class="list-group-item text-muted text-center py-4">No one is currently checked in.</li>
        {% endfor %}
      </ul>
    </div>
  </div>

  <div class="col-lg-4 col-12 mt-3 mt-lg-0">
    <div class="card mb-3">
      <div class="card-header" style="background-color: #003b59; color: white;"><strong>Quick Actions</strong></div>
      <div class="card-body">
        <div class="d-grid gap-2">
          <a href="/kiosk" class="btn" style="background-color: #79060d; color: white; border: none;">
            <span style="font-size: 1.2rem;">üì±</span> Kiosk Mode
          </a>
          <a href="/admin" class="btn" style="background-color: #003b59; color: white; border: none;">
            <span style="font-size: 1.2rem;">‚öôÔ∏è</span> Admin Panel
          </a>
          <a href="/history" class="btn btn-outline-secondary">
            <span style="font-size: 1.2rem;">üìã</span> View History
          </a>
        </div>
      </div>
    </div>

    <div class="card d-none d-lg-block">
      <div class="card-header"><strong>About</strong></div>
      <div class="card-body">
        <p class="small mb-2">This system supports family-based check-in using the last 4 digits of phone numbers.</p>
        <p class="small mb-0 text-muted">Configure families, adults, kids, and events in the Admin panel.</p>
      </div>
    </div>
  </div>
</div>

<!-- Mobile event selector modal -->
<div class="modal fade" id="eventModalIndex" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header" style="background-color: #79060d; color: white;">
        <h5 class="modal-title">Select Event</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" style="max-height:60vh; overflow-y:auto;">
        <div class="list-group">
          {% for event in events %}
          <a href="/?event_id={{ event['id'] }}" class="list-group-item list-group-item-action {% if event['id'] == current_event_id %}active{% endif %}">
            {{ event['start_time'][:10] }} ‚Äî {{ event['name'] }}
          </a>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal -->
<div class="modal fade" id="familyModal" tabindex="-1" aria-labelledby="familyModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header" style="background-color: #79060d; color: white;">
        <h5 class="modal-title" id="familyModalLabel">Select Kids to Check In</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p><strong>Phone:</strong> <span id="modal-phone"></span></p>
        <p><strong>Troop:</strong> <span id="modal-troop"></span></p>
        <form id="select-kids-form">
          <input type="hidden" id="family-id" name="family_id">
          <input type="hidden" id="modal-event-id" name="event_id" value="{{ current_event_id }}">
          <div class="mb-3">
            <label class="form-label">Checking in as:</label>
            <select name="adult_id" id="adult-select" class="form-select" required>
              <option value="">Select Adult</option>
            </select>
          </div>
          <div id="kids-list"></div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn" style="background-color: #003b59; color: white; border: none;" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" form="select-kids-form" class="btn" style="background-color: #4a582d; color: white; border: none;">Check In Selected</button>
      </div>
    </div>
  </div>
</div>

<script>
document.getElementById('event-select').addEventListener('change', function() {
  const eventId = this.value;
  window.location.href = `/?event_id=${eventId}`;
});

document.getElementById('checkin-form').addEventListener('submit', function(e) {
  e.preventDefault();
  const last4 = document.getElementById('last4').value;
  const eventId = document.getElementById('event-id').value;
  fetch('/checkin_last4', {
    method: 'POST',
    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
    body: new URLSearchParams({last4: last4, event_id: eventId})
  })
  .then(response => response.json())
  .then(data => {
    if (data.error) {
      alert(data.error);
      return;
    }
    document.getElementById('modal-phone').textContent = data.phone;
    document.getElementById('modal-troop').textContent = data.troop || '‚Äî';
    document.getElementById('family-id').value = data.family_id;
    const adultSelect = document.getElementById('adult-select');
    adultSelect.innerHTML = '<option value="">Select Adult</option>';
    data.adults.forEach((adult, index) => {
      const option = document.createElement('option');
      option.value = adult.id;
      option.textContent = adult.name;
      // Select the default adult if specified, otherwise select the first one
      const isSelected = data.default_adult_id ? adult.id === data.default_adult_id : index === 0;
      if (isSelected) option.selected = true;
      adultSelect.appendChild(option);
    });
    const kidsList = document.getElementById('kids-list');
    kidsList.innerHTML = '';
    data.kids.forEach(kid => {
      const div = document.createElement('div');
      div.className = 'form-check';
      div.innerHTML = `
        <input class="form-check-input" type="checkbox" name="kid_ids" value="${kid.id}" id="kid-${kid.id}">
        <label class="form-check-label" for="kid-${kid.id}">${kid.name}</label>
      `;
      kidsList.appendChild(div);
    });
    new bootstrap.Modal(document.getElementById('familyModal')).show();
  })
  .catch(error => console.error('Error:', error));
});

document.getElementById('select-kids-form').addEventListener('submit', function(e) {
  e.preventDefault();
  const formData = new FormData(this);
  fetch('/checkin_selected', {
    method: 'POST',
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    bootstrap.Modal.getInstance(document.getElementById('familyModal')).hide();
    
    // Print labels if any were returned
    if (data.labels && data.labels.length > 0) {
      data.labels.forEach(label => {
        printDymoLabel(
          label.kid_name,
          label.event_name,
          label.event_date,
          label.checkin_time,
          label.checkout_code
        );
      });
    }
    
    // Add check-ins to the page dynamically
    if (data.checkins && data.checkins.length > 0) {
      const checkedInDiv = document.getElementById('checked-in-list');
      const eventId = document.querySelector('[name="event_id"]').value;
      
      data.checkins.forEach(checkin => {
        const card = document.createElement('div');
        card.className = 'card mb-2';
        card.innerHTML = `
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <h5 class="card-title mb-1">${checkin.kid_name}
                  ${checkin.kid_notes ? '<i class="bi bi-sticky text-muted" style="font-size: 0.7rem; opacity: 0.6;" data-bs-toggle="tooltip" title="' + checkin.kid_notes + '">üìã</i>' : ''}
                  ${checkin.authorized_adults ? '<i class="bi bi-person-check text-muted" style="font-size: 0.7rem; opacity: 0.6;" data-bs-toggle="tooltip" title="Authorized: ' + checkin.authorized_adults + '">üë§</i>' : ''}
                </h5>
                <p class="card-text mb-0">
                  <small class="text-muted">
                    <strong>${checkin.adult_name}</strong> ‚Ä¢ ${checkin.phone}<br>
                    ${checkin.formatted_time}
                  </small>
                </p>
              </div>
              <button class="btn btn-danger btn-sm checkout-btn" 
                      data-kid-id="${checkin.kid_id}" 
                      data-kid-name="${checkin.kid_name}"
                      data-event-id="${eventId}">Check Out</button>
            </div>
          </div>
        `;
        checkedInDiv.insertBefore(card, checkedInDiv.firstChild);
      });
      
      // Update count in header
      const countBadge = document.querySelector('h2 .badge');
      if (countBadge) {
        const currentCount = parseInt(countBadge.textContent) || 0;
        countBadge.textContent = currentCount + data.checkins.length;
      }
      
      // Initialize tooltips for new elements
      const tooltips = card.querySelectorAll('[data-bs-toggle="tooltip"]');
      tooltips.forEach(el => new bootstrap.Tooltip(el));
    }
    
    // Show success message
    if (data.message) {
      const alert = document.createElement('div');
      alert.className = 'alert alert-success alert-dismissible fade show';
      alert.innerHTML = `
        ${data.message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      `;
      document.querySelector('.container').insertBefore(alert, document.querySelector('.container').firstChild);
      setTimeout(() => alert.remove(), 3000);
    }
  })
  .catch(error => console.error('Error:', error));
});

// Handle checkout with code verification
document.addEventListener('click', function(e) {
  if (e.target.classList.contains('checkout-btn')) {
    const kidId = e.target.dataset.kidId;
    const kidName = e.target.dataset.kidName;
    const eventId = e.target.dataset.eventId;
    
    // First, check out without code to see if code is required
    const formData = new FormData();
    formData.append('event_id', eventId);
    
    fetch(`/checkout/${kidId}`, {
      method: 'POST',
      headers: {
        'X-Requested-With': 'XMLHttpRequest'
      },
      body: formData
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        location.reload();
      } else if (data.code_required) {
        // Prompt for checkout code
        const code = prompt(`Enter checkout code for ${kidName}:`);
        if (code) {
          const codeFormData = new FormData();
          codeFormData.append('event_id', eventId);
          codeFormData.append('checkout_code', code);
          
          fetch(`/checkout/${kidId}`, {
            method: 'POST',
            headers: {
              'X-Requested-With': 'XMLHttpRequest'
            },
            body: codeFormData
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              location.reload();
            } else {
              alert(data.message || 'Invalid checkout code');
            }
          });
        }
      } else {
        alert(data.message || 'Checkout failed');
      }
    })
    .catch(error => console.error('Error:', error));
  }
});

// Enable Bootstrap tooltips
document.addEventListener('DOMContentLoaded', function() {
  var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
  var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl);
  });
});
</script>
<script src="/static/dymo_print.js"></script>
{% endblock %}
