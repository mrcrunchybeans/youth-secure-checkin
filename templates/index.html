{% extends 'base.html' %}
{% block content %}
<style>
  /* Ensure checkout keypad is always visible and accessible */
  #checkout-keypad {
    position: sticky;
    bottom: 0;
    background: white;
    z-index: 10;
    padding: 0.5rem 0;
    margin: 0 !important;
  }
  
  /* Improve modal scrolling on tablets */
  .modal-dialog {
    max-height: 90vh;
  }
  
  .modal-body {
    max-height: 70vh;
    overflow-y: auto;
  }
  
  /* iPad Pro and tablet-specific optimizations (768px - 1366px) */
  @media (min-width: 768px) and (max-width: 1366px) {
    #checkout-keypad {
      margin-top: 1rem !important;
      padding: 0.75rem;
      border-radius: 8px;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
    }
    
    #checkout-keypad .btn {
      font-size: 1.4rem !important;
      padding: 0.75rem !important;
      min-height: 60px;
    }
    
    #checkout-code-input {
      font-size: 1.8rem !important;
      padding: 0.75rem !important;
    }
    
    .modal-content {
      border-radius: 12px;
    }
  }
  
  /* Mobile phone optimizations (< 768px) */
  @media (max-width: 767px) {
    #checkout-keypad {
      padding: 0.5rem;
      border-top: 1px solid #dee2e6;
    }
    
    #checkout-keypad .btn {
      font-size: 1.2rem !important;
      padding: 0.5rem !important;
      min-height: 50px;
    }
    
    #checkout-code-input {
      font-size: 1.5rem !important;
      padding: 0.5rem !important;
    }
    
    .card-header {
      padding: 0.75rem;
      font-size: 1rem;
    }
    
    .event-select-mobile {
      max-width: 100% !important;
      font-size: 0.9rem;
    }
    
    #checkin-form .col-auto {
      width: 100%;
    }
    
    #checkin-form button {
      width: 100%;
      margin-top: 0.5rem;
      height: 45px;
    }
    
    .list-group-item {
      flex-direction: column;
      align-items: flex-start !important;
      padding: 1rem;
    }
    
    .list-group-item form {
      width: 100%;
      margin-top: 0.75rem;
    }
    
    .list-group-item form button {
      width: 100%;
      height: 45px;
    }
  }
</style>
<div class="row">
  <div class="col-lg-8 col-12">
    <div class="card mb-3">
      <div class="card-header d-flex justify-content-between align-items-center flex-wrap" style="background-color: {{ branding.primary_color }}; color: white;">
        <strong class="mb-1 mb-sm-0">Family Lookup</strong>
        <!-- Desktop: Bootstrap dropdown -->
        <div class="dropdown d-none d-sm-inline-block">
          <button class="btn btn-light btn-sm dropdown-toggle" type="button" id="eventDropdownIndex" data-bs-toggle="dropdown" aria-expanded="false" title="{{ events|selectattr('id', 'equalto', current_event_id)|map(attribute='name')|first }}">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-calendar-event" viewBox="0 0 16 16" style="margin-bottom: 2px;">
              <path d="M11 6.5a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1z"/>
              <path d="M3.5 0a.5.5 0 0 1 .5.5V1h8V.5a.5.5 0 0 1 1 0V1h1a2 2 0 0 1 2 2v11a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V3a2 2 0 0 1 2-2h1V.5a.5.5 0 0 1 .5-.5zM1 4v10a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V4H1z"/>
            </svg>
            <span class="d-none d-lg-inline ms-1">{{ events|selectattr('id', 'equalto', current_event_id)|map(attribute='name')|first }}</span>
          </button>
          <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="eventDropdownIndex">
            {% for event in events %}
            <li><a class="dropdown-item" href="{{ url_for('index', event_id=event['id']) }}">{{ event['name'] }} - {{ event['start_time'][:10] }}</a></li>
            {% endfor %}
          </ul>
        </div>
        <!-- Mobile: button opens modal -->
        <button type="button" class="btn btn-sm btn-light d-inline d-sm-none" data-bs-toggle="modal" data-bs-target="#eventModalIndex">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-calendar-event" viewBox="0 0 16 16">
            <path d="M11 6.5a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1z"/>
            <path d="M3.5 0a.5.5 0 0 1 .5.5V1h8V.5a.5.5 0 0 1 1 0V1h1a2 2 0 0 1 2 2v11a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V3a2 2 0 0 1 2-2h1V.5a.5.5 0 0 1 .5-.5zM1 4v10a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V4H1z"/>
          </svg>
        </button>
      </div>
      <div class="card-body">
        <form id="checkin-form" class="row g-3 align-items-end">
          <input type="hidden" id="event-id" name="event_id" value="{{ current_event_id }}">
          <div class="col-auto col-md-8" style="flex: 1;">
            <label class="form-label fw-bold">Search by Last 4 Digits of Phone or Name</label>
            <input id="search-input" class="form-control" placeholder="Enter phone (last 4) or name (partial)" />
            <small class="text-muted">Enter 4 digits for phone lookup or any text for name search</small>
          </div>
          <div class="col-auto col-md-4">
            <button type="submit" class="btn" style="background-color: {{ branding.primary_color }}; color: white; border: none; padding: 0.5rem 2rem;">Search</button>
          </div>
        </form>
      </div>
    </div>

    <div class="card">
      <div class="card-header" style="background-color: {{ branding.accent_color }}; color: white;"><strong>Currently Checked In - <span class="checked-in-count">{{ checked_in|length }}</span></strong></div>
      <ul class="list-group list-group-flush" id="checked-in-list" style="max-height: 500px; overflow-y: auto;">
        {% for row in checked_in %}
          <li class="list-group-item d-flex justify-content-between align-items-center py-2">
            <div style="flex: 1;">
              <div>
                <strong style="font-size: 1.1rem;">{{ row['kid_name'] }}</strong>
                {% if row['kid_notes'] %}
                  <span class="text-muted ms-1" style="cursor: pointer; font-size: 0.7rem; opacity: 0.6;" 
                        data-bs-toggle="tooltip" data-bs-placement="top" data-bs-html="true"
                        title="{{ row['kid_notes'] | replace('\n', '<br>') }}">‚ÑπÔ∏è</span>
                {% endif %}
                {% if row['authorized_adults'] %}
                  <span class="text-muted ms-1" style="cursor: pointer; font-size: 0.7rem; opacity: 0.6;" 
                        data-bs-toggle="tooltip" data-bs-placement="top" data-bs-html="true"
                        title="<strong>Authorized for Checkout:</strong><br>{{ row['authorized_adults'] | replace('\n', '<br>') }}">üë§</span>
                {% endif %}
                <span class="text-muted d-block d-sm-inline">‚Äî {{ row['adult_name'] }}</span>
              </div>
              <small class="text-muted d-block">Phone: {{ row['phone'] }} ¬∑ {{ row['formatted_time'] }}</small>
            </div>
            <button class="btn btn-sm checkout-btn" style="color: {{ branding.primary_color }}; border-color: {{ branding.primary_color }}; white-space: nowrap;" 
                    data-kid-id="{{ row['kid_id'] }}" 
                    data-kid-name="{{ row['kid_name'] }}" 
                    data-event-id="{{ current_event_id }}">Check Out</button>
          </li>
        {% else %}
          <li class="list-group-item text-muted text-center py-4">No one is currently checked in.</li>
        {% endfor %}
      </ul>
    </div>
  </div>

  <div class="col-lg-4 col-12 mt-3 mt-lg-0">
    <div class="card mb-3">
      <div class="card-header" style="background-color: {{ branding.secondary_color }}; color: white;"><strong>Quick Actions</strong></div>
      <div class="card-body">
        <div class="d-grid gap-2">
          <a href="/kiosk" class="btn" style="background-color: {{ branding.primary_color }}; color: white; border: none;">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="bi bi-tablet" viewBox="0 0 16 16" style="margin-bottom: 2px;">
              <path d="M12 1a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h8zM4 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H4z"/>
              <path d="M8 14a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/>
            </svg>
            Kiosk Mode
          </a>
          <a href="/admin" class="btn" style="background-color: {{ branding.secondary_color }}; color: white; border: none;">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="bi bi-sliders" viewBox="0 0 16 16" style="margin-bottom: 2px;">
              <path fill-rule="evenodd" d="M11.5 2a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3zM9.05 3a2.5 2.5 0 0 1 4.9 0H16v1h-2.05a2.5 2.5 0 0 1-4.9 0H0V3h9.05zM4.5 7a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3zM2.05 8a2.5 2.5 0 0 1 4.9 0H16v1H6.95a2.5 2.5 0 0 1-4.9 0H0V8h2.05zm9.45 4a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3zm-2.45 1a2.5 2.5 0 0 1 4.9 0H16v1h-2.05a2.5 2.5 0 0 1-4.9 0H0v-1h9.05z"/>
            </svg>
            Admin Panel
          </a>
          <a href="/history" class="btn btn-outline-secondary">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="bi bi-clock-history" viewBox="0 0 16 16" style="margin-bottom: 2px;">
              <path d="M8.515 1.019A7 7 0 0 0 8 1V0a8 8 0 0 1 .589.022l-.074.997zm2.004.45a7.003 7.003 0 0 0-.985-.299l.219-.976c.383.086.76.2 1.126.342l-.36.933zm1.37.71a7.01 7.01 0 0 0-.439-.27l.493-.87a8.025 8.025 0 0 1 .979.654l-.615.789a6.996 6.996 0 0 0-.418-.302zm1.834 1.79a6.99 6.99 0 0 0-.653-.796l.724-.69c.27.285.52.59.747.91l-.818.576zm.744 1.352a7.08 7.08 0 0 0-.214-.468l.893-.45a7.976 7.976 0 0 1 .45 1.088l-.95.313a7.023 7.023 0 0 0-.179-.483zm.53 2.507a6.991 6.991 0 0 0-.1-1.025l.985-.17c.067.386.106.778.116 1.17l-1 .025zm-.131 1.538c.033-.17.06-.339.081-.51l.993.123a7.957 7.957 0 0 1-.23 1.155l-.964-.267c.046-.165.086-.332.12-.501zm-.952 2.379c.184-.29.346-.594.486-.908l.914.405c-.16.36-.345.706-.555 1.038l-.845-.535zm-.964 1.205c.122-.122.239-.248.35-.378l.758.653a8.073 8.073 0 0 1-.401.432l-.707-.707z"/>
              <path d="M8 1a7 7 0 1 0 4.95 11.95l.707.707A8.001 8.001 0 1 1 8 0v1z"/>
              <path d="M7.5 3a.5.5 0 0 1 .5.5v5.21l3.248 1.856a.5.5 0 0 1-.496.868l-3.5-2A.5.5 0 0 1 7 9V3.5a.5.5 0 0 1 .5-.5z"/>
            </svg>
            View History
          </a>
        </div>
      </div>
    </div>

    <div class="card d-none d-lg-block">
      <div class="card-header"><strong>About</strong></div>
      <div class="card-body">
        <p class="small mb-2">This system supports family-based check-in using the last 4 digits of phone numbers.</p>
        <p class="small mb-0 text-muted">Configure families, adults, kids, and events in the Admin panel.</p>
      </div>
    </div>
  </div>
</div>

<!-- Mobile event selector modal -->
<div class="modal fade" id="eventModalIndex" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header" style="background-color: {{ branding.primary_color }}; color: white;">
        <h5 class="modal-title">Select Event</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" style="max-height:60vh; overflow-y:auto;">
        <div class="list-group">
          {% for event in events %}
          <a href="/?event_id={{ event['id'] }}" class="list-group-item list-group-item-action {% if event['id'] == current_event_id %}active{% endif %}">
            {{ event['start_time'][:10] }} ‚Äî {{ event['name'] }}
          </a>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal -->
<div class="modal fade" id="familyModal" tabindex="-1" aria-labelledby="familyModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header" style="background-color: {{ branding.primary_color }}; color: white;">
        <h5 class="modal-title" id="familyModalLabel">Select Kids to Check In</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p><strong>Phone:</strong> <span id="modal-phone"></span></p>
        <p><strong>{{ branding.group_term }}:</strong> <span id="modal-troop"></span></p>
        <form id="select-kids-form">
          <input type="hidden" id="family-id" name="family_id">
          <input type="hidden" id="modal-event-id" name="event_id" value="{{ current_event_id }}">
          <div class="mb-3">
            <label class="form-label">Checking in as:</label>
            <select name="adult_id" id="adult-select" class="form-select" required>
              <option value="">Select Adult</option>
            </select>
          </div>
          <div id="kids-list"></div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn" style="background-color: {{ branding.secondary_color }}; color: white; border: none;" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" form="select-kids-form" class="btn" style="background-color: {{ branding.accent_color }}; color: white; border: none;">Check In Selected</button>
      </div>
    </div>
  </div>
</div>

<!-- Name Search Results Modal -->
<div class="modal fade" id="nameResultsModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header" style="background-color: {{ branding.primary_color }}; color: white;">
        <h5 class="modal-title">Multiple Families Found - Select One</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="name-results-list"></div>
      </div>
    </div>
  </div>
</div>

<!-- QR Code Modal -->
<div class="modal fade" id="qrCodeModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered" style="max-width: 420px;">
    <div class="modal-content" style="border-radius: 15px; overflow: hidden; border: 3px solid {{ branding.primary_color }};">
      <div class="modal-header" style="background: linear-gradient(135deg, {{ branding.primary_color }} 0%, {{ branding.secondary_color }} 100%); color: white; border: none; padding: 1rem;">
        <h5 class="modal-title" style="font-size: 1.3rem; font-weight: 700;">üì± Scan for Checkout Code</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center" style="padding: 1.5rem;">
        <img id="qr-code-img" src="" alt="QR Code" style="max-width: 250px; width: 100%; border: 5px solid #f8f9fa; border-radius: 10px;">
        <div class="mt-3 mb-2" style="background: #f8f9fa; border: 2px solid {{ branding.primary_color }}; border-radius: 10px; padding: 0.8rem;">
          <div class="text-muted mb-1" style="font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05rem;">Checkout Code</div>
          <div id="qr-code-text" style="font-size: 1.8rem; font-weight: bold; color: {{ branding.primary_color }}; font-family: 'Courier New', monospace; letter-spacing: 0.3rem;"></div>
        </div>
        <div id="short-url-container" style="display: none; margin-top: 1rem;">
          <p class="text-muted mb-1" style="font-size: 0.75rem;">Or visit:</p>
          <a id="short-url-link" href="" target="_blank" style="font-size: 1.1rem; font-weight: 600; color: {{ branding.primary_color }}; text-decoration: none; word-break: break-all;"></a>
        </div>
        <p class="text-muted mb-0 mt-2" style="font-size: 0.85rem; line-height: 1.4;">Scan QR code, visit the link, or write down the code above</p>
      </div>
      <div class="modal-footer" style="border: none; justify-content: center; padding: 1rem 1.5rem;">
        <button type="button" class="btn" style="background: linear-gradient(135deg, {{ branding.primary_color }} 0%, {{ branding.secondary_color }} 100%); color: white; border: none; border-radius: 10px; padding: 0.6rem 2rem; font-size: 1.1rem; font-weight: 600;" data-bs-dismiss="modal">Done</button>
      </div>
    </div>
  </div>
</div>

<!-- Checkout Code Entry Modal -->
<div class="modal fade" id="checkoutCodeModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered" style="max-width: 380px;">
    <div class="modal-content" style="border-radius: 15px; overflow: hidden; border: 3px solid {{ branding.primary_color }};">
      <div class="modal-header" style="background: linear-gradient(135deg, {{ branding.primary_color }} 0%, {{ branding.secondary_color }} 100%); color: white; border: none; padding: 0.6rem 0.9rem;">
        <h5 class="modal-title" style="font-size: 1.15rem; font-weight: 700;">üîí Enter Code</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" style="padding: 0.8rem;">
        <p class="text-center mb-2" style="font-size: 0.9rem; font-weight: 600; color: #333;" id="checkout-kid-name"></p>
        
        <!-- Siblings section -->
        <div id="siblings-section" style="display: none;">
          <div class="mb-2" style="padding: 0.5rem; background: #f8f9fa; border-radius: 6px; border: 1px solid #dee2e6;">
            <div class="text-muted mb-1" style="font-size: 0.75rem; font-weight: 600;">Also check out:</div>
            <div id="siblings-list" style="max-height: 80px; overflow-y: auto;"></div>
          </div>
        </div>
        
        <form id="checkout-code-form">
          <div class="mb-2" id="checkout-code-section" {% if not require_codes %}style="display: none;"{% endif %}>
            <input type="text" class="form-control text-center" id="checkout-code-input" 
                   style="font-size: 1.4rem; letter-spacing: 0.3rem; font-family: 'Courier New', monospace; border: 2px solid {{ branding.primary_color }}; font-weight: bold; padding: 0.35rem;"
                   maxlength="10" {% if require_codes %}required{% endif %} autocomplete="off" inputmode="none" placeholder="Code">
          </div>
          
          <!-- On-screen keypad -->
          <div id="checkout-keypad" class="mb-2" {% if not require_codes %}style="display: none;"{% endif %}>
            <div class="d-grid" style="grid-template-columns: repeat(3, 1fr); gap: 0.35rem; display: grid;">
              <button type="button" class="btn btn-outline-secondary checkout-key" data-value="1" style="font-size: 1.2rem; padding: 0.4rem; font-weight: 600;">1</button>
              <button type="button" class="btn btn-outline-secondary checkout-key" data-value="2" style="font-size: 1.2rem; padding: 0.4rem; font-weight: 600;">2</button>
              <button type="button" class="btn btn-outline-secondary checkout-key" data-value="3" style="font-size: 1.2rem; padding: 0.4rem; font-weight: 600;">3</button>
              <button type="button" class="btn btn-outline-secondary checkout-key" data-value="4" style="font-size: 1.2rem; padding: 0.4rem; font-weight: 600;">4</button>
              <button type="button" class="btn btn-outline-secondary checkout-key" data-value="5" style="font-size: 1.2rem; padding: 0.4rem; font-weight: 600;">5</button>
              <button type="button" class="btn btn-outline-secondary checkout-key" data-value="6" style="font-size: 1.2rem; padding: 0.4rem; font-weight: 600;">6</button>
              <button type="button" class="btn btn-outline-secondary checkout-key" data-value="7" style="font-size: 1.2rem; padding: 0.4rem; font-weight: 600;">7</button>
              <button type="button" class="btn btn-outline-secondary checkout-key" data-value="8" style="font-size: 1.2rem; padding: 0.4rem; font-weight: 600;">8</button>
              <button type="button" class="btn btn-outline-secondary checkout-key" data-value="9" style="font-size: 1.2rem; padding: 0.4rem; font-weight: 600;">9</button>
              <button type="button" class="btn btn-outline-danger" id="checkout-keypad-clear" style="font-size: 0.9rem; padding: 0.4rem; font-weight: 600;">Clear</button>
              <button type="button" class="btn btn-outline-secondary checkout-key" data-value="0" style="font-size: 1.2rem; padding: 0.4rem; font-weight: 600;">0</button>
              <button type="button" class="btn btn-outline-warning" id="checkout-keypad-back" style="font-size: 0.9rem; padding: 0.4rem; font-weight: 600;">‚Üê</button>
            </div>
          </div>
          
          <div class="d-grid" style="gap: 0.35rem;">
            <button type="submit" class="btn" style="background: linear-gradient(135deg, {{ branding.accent_color }} 0%, {{ branding.primary_color }} 100%); color: white; border: none; border-radius: 10px; padding: 0.5rem; font-size: 1rem; font-weight: 600;">
              ‚úì Check Out
            </button>
            <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal" style="border-radius: 10px; padding: 0.3rem; font-size: 0.85rem;">
              Cancel
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
function showQRCodeModal(qrCodeData, checkoutCode, shortUrl) {
  document.getElementById('qr-code-img').src = qrCodeData;
  document.getElementById('qr-code-text').textContent = checkoutCode || '';
  
  // Show short URL if available
  const shortUrlContainer = document.getElementById('short-url-container');
  const shortUrlLink = document.getElementById('short-url-link');
  if (shortUrl) {
    shortUrlLink.href = shortUrl;
    shortUrlLink.textContent = shortUrl;
    shortUrlContainer.style.display = 'block';
  } else {
    shortUrlContainer.style.display = 'none';
  }
  
  new bootstrap.Modal(document.getElementById('qrCodeModal')).show();
}

// Unified search handler - detects if input is numeric (phone) or text (name)
document.getElementById('checkin-form').addEventListener('submit', function(e) {
  e.preventDefault();
  const searchInput = document.getElementById('search-input').value.trim();
  const eventId = document.getElementById('event-id').value;
  
  if (!searchInput) {
    alert('Please enter a phone number or name to search');
    return;
  }
  
  // Check if input is all digits (phone search) or text (name search)
  const isPhoneSearch = /^\d+$/.test(searchInput);
  
  if (isPhoneSearch) {
    // Phone search - accept any length, will search by digits
    fetch('/checkin_last4', {
      method: 'POST',
      headers: {'Content-Type': 'application/x-www-form-urlencoded'},
      body: new URLSearchParams({last4: searchInput, event_id: eventId})
    })
    .then(response => response.json())
    .then(data => {
      if (data.error) {
        alert(data.error);
        return;
      }
      
      // Handle multiple matches (like name search)
      if (data.families && data.families.length > 0) {
        if (data.families.length === 1) {
          populateFamilyModal(data.families[0]);
          new bootstrap.Modal(document.getElementById('familyModal')).show();
        } else {
          showMultipleFamilies(data.families);
        }
      } else {
        // Single match returned directly
        populateFamilyModal(data);
        new bootstrap.Modal(document.getElementById('familyModal')).show();
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Search failed');
    });
  } else {
    // Name search
    fetch('/search_name', {
      method: 'POST',
      headers: {'Content-Type': 'application/x-www-form-urlencoded'},
      body: new URLSearchParams({name: searchInput, event_id: eventId})
    })
    .then(response => response.json())
    .then(data => {
      const families = data.families || [];
      
      if (families.length === 0) {
        alert('No matches found');
        return;
      }
      
      if (families.length === 1) {
        populateFamilyModal(families[0]);
        new bootstrap.Modal(document.getElementById('familyModal')).show();
      } else {
        showMultipleFamilies(families);
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Search failed. Please try again.');
    });
  }
});

document.getElementById('select-kids-form').addEventListener('submit', function(e) {
  e.preventDefault();
  const formData = new FormData(this);
  fetch('/checkin_selected', {
    method: 'POST',
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    bootstrap.Modal.getInstance(document.getElementById('familyModal')).hide();
    
    // Show QR code if available
    if (data.qr_code) {
      showQRCodeModal(data.qr_code, data.checkout_code, data.short_url);
    }
    
    // Print labels if any were returned (deferred to prevent UI blocking)
    if (data.labels && data.labels.length > 0) {
      data.labels.forEach(label => {
        setTimeout(() => {
          printDymoLabel(
            label.kid_name,
            label.event_name,
            label.event_date,
            label.checkin_time,
            label.checkout_code,
            data.label_size || '30336'
          );
        }, 0);
      });
    }
    
    // Add check-ins to the page dynamically
    if (data.checkins && data.checkins.length > 0) {
      const checkedInList = document.getElementById('checked-in-list');
      const eventId = document.querySelector('[name="event_id"]').value;
      const primaryColor = '{{ branding.primary_color }}';
      
      // Remove "no one checked in" message if it exists
      const emptyMessage = checkedInList.querySelector('.text-muted.text-center');
      if (emptyMessage) {
        emptyMessage.remove();
      }
      
      data.checkins.forEach(checkin => {
        const listItem = document.createElement('li');
        listItem.className = 'list-group-item d-flex justify-content-between align-items-center py-2';
        listItem.innerHTML = `
          <div style="flex: 1;">
            <div>
              <strong style="font-size: 1.1rem;">${checkin.kid_name}</strong>
              ${checkin.kid_notes ? '<span class="text-muted ms-1" style="cursor: pointer; font-size: 0.7rem; opacity: 0.6;" data-bs-toggle="tooltip" title="' + checkin.kid_notes + '">‚ÑπÔ∏è</span>' : ''}
              ${checkin.authorized_adults ? '<span class="text-muted ms-1" style="cursor: pointer; font-size: 0.7rem; opacity: 0.6;" data-bs-toggle="tooltip" title="Authorized: ' + checkin.authorized_adults + '">üë§</span>' : ''}
              <span class="text-muted d-block d-sm-inline">‚Äî ${checkin.adult_name}</span>
            </div>
            <small class="text-muted d-block">Phone: ${checkin.phone} ¬∑ ${checkin.formatted_time}</small>
          </div>
          <button class="btn btn-sm checkout-btn" style="color: ${primaryColor}; border-color: ${primaryColor}; white-space: nowrap;" 
                  data-kid-id="${checkin.kid_id}" 
                  data-kid-name="${checkin.kid_name}"
                  data-event-id="${eventId}">Check Out</button>
        `;
        checkedInList.insertBefore(listItem, checkedInList.firstChild);
        
        // Initialize tooltips for this list item
        const tooltips = listItem.querySelectorAll('[data-bs-toggle="tooltip"]');
        tooltips.forEach(el => new bootstrap.Tooltip(el));
      });
      
      // Update count in header
      const countElement = document.querySelector('.checked-in-count');
      if (countElement) {
        const currentCount = parseInt(countElement.textContent) || 0;
        countElement.textContent = currentCount + data.checkins.length;
      }
    }
    
    // Show success message
    if (data.message) {
      const alert = document.createElement('div');
      alert.className = 'alert alert-success alert-dismissible fade show';
      alert.innerHTML = `
        ${data.message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      `;
      document.querySelector('.container').insertBefore(alert, document.querySelector('.container').firstChild);
      setTimeout(() => alert.remove(), 3000);
    }
  })
  .catch(error => console.error('Error:', error));
});

// Handle checkout with code verification
let currentCheckoutData = null;

document.addEventListener('click', function(e) {
  if (e.target.classList.contains('checkout-btn')) {
    const kidId = e.target.dataset.kidId;
    const kidName = e.target.dataset.kidName;
    const eventId = e.target.dataset.eventId;
    
    // Store data for later use
    currentCheckoutData = { kidId, kidName, eventId };
    
    // First, fetch siblings to show in modal
    const siblingFormData = new FormData();
    siblingFormData.append('event_id', eventId);
    
    fetch(`/get_siblings/${kidId}`, {
      method: 'POST',
      body: siblingFormData
    })
    .then(response => response.json())
    .then(siblingData => {
      console.log('Siblings response:', siblingData);
      // Store sibling data for use in form submission
      currentCheckoutData.siblings = (siblingData.success && siblingData.siblings) ? siblingData.siblings : [];
      
      const requireCodes = {{ 'true' if require_codes else 'false' }};
      
      // If there are siblings OR codes are required, show the modal
      if (currentCheckoutData.siblings.length > 0 || requireCodes) {
        // Show modal with siblings for checkout
        document.getElementById('checkout-kid-name').textContent = kidName;
        document.getElementById('checkout-code-input').value = '';
        
        // Show/hide siblings section based on whether there are siblings
        const siblingsSection = document.getElementById('siblings-section');
        const siblingsList = document.getElementById('siblings-list');
        if (currentCheckoutData.siblings.length > 0) {
          siblingsList.innerHTML = '';
          currentCheckoutData.siblings.forEach(sibling => {
            const div = document.createElement('div');
            div.className = 'form-check';
            div.innerHTML = `
              <input class="form-check-input sibling-checkbox" type="checkbox" value="${sibling.kid_id}" id="sib-${sibling.kid_id}" checked>
              <label class="form-check-label" for="sib-${sibling.kid_id}" style="font-size: 0.9rem;">${sibling.name}</label>
            `;
            siblingsList.appendChild(div);
          });
          siblingsSection.style.display = 'block';
        } else {
          siblingsSection.style.display = 'none';
        }
        
        // Show/hide code section based on requireCodes setting
        const codeSection = document.getElementById('checkout-code-section');
        const keypad = document.getElementById('checkout-keypad');
        const codeInput = document.getElementById('checkout-code-input');
        if (requireCodes) {
          codeSection.style.display = 'block';
          keypad.style.display = 'block';
          codeInput.required = true;
        } else {
          codeSection.style.display = 'none';
          keypad.style.display = 'none';
          codeInput.required = false;
        }
        
        const modal = new bootstrap.Modal(document.getElementById('checkoutCodeModal'));
        modal.show();
        // Focus input after modal is shown
        document.getElementById('checkoutCodeModal').addEventListener('shown.bs.modal', function() {
          if (requireCodes) {
            document.getElementById('checkout-code-input').focus();
          }
        }, { once: true });
      } else {
        // No siblings, proceed with normal checkout flow
        const formData = new FormData();
        formData.append('event_id', eventId);
        
        fetch(`/checkout/${kidId}`, {
          method: 'POST',
          headers: {
            'X-Requested-With': 'XMLHttpRequest'
          },
          body: formData
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            location.reload();
          } else if (data.code_required) {
            // Show modal for checkout code
            document.getElementById('checkout-kid-name').textContent = kidName;
            document.getElementById('checkout-code-input').value = '';
            document.getElementById('siblings-section').style.display = 'none';
            
            const modal = new bootstrap.Modal(document.getElementById('checkoutCodeModal'));
            modal.show();
            // Focus input after modal is shown
            document.getElementById('checkoutCodeModal').addEventListener('shown.bs.modal', function() {
              document.getElementById('checkout-code-input').focus();
            }, { once: true });
          } else {
            alert(data.message || 'Checkout failed');
          }
        })
        .catch(error => console.error('Error:', error));
      }
    })
    .catch(error => console.error('Error fetching siblings:', error));
  }
});

// Checkout code keypad handlers
document.addEventListener('DOMContentLoaded', function() {
  const checkoutInput = document.getElementById('checkout-code-input');
  const checkoutKeys = document.querySelectorAll('.checkout-key');
  const checkoutBack = document.getElementById('checkout-keypad-back');
  const checkoutClear = document.getElementById('checkout-keypad-clear');
  
  checkoutKeys.forEach(key => {
    key.addEventListener('click', function() {
      const value = this.dataset.value;
      if (checkoutInput.value.length < 10) {
        checkoutInput.value += value;
      }
    });
  });
  
  if (checkoutBack) {
    checkoutBack.addEventListener('click', function() {
      checkoutInput.value = checkoutInput.value.slice(0, -1);
    });
  }
  
  if (checkoutClear) {
    checkoutClear.addEventListener('click', function() {
      checkoutInput.value = '';
    });
  }
});

// Handle checkout code form submission
document.getElementById('checkout-code-form').addEventListener('submit', function(e) {
  e.preventDefault();
  
  if (!currentCheckoutData) return;
  
  const code = document.getElementById('checkout-code-input').value.trim();
  
  const codeFormData = new FormData();
  codeFormData.append('event_id', currentCheckoutData.eventId);
  if (code) {
    codeFormData.append('checkout_code', code);
  }
  
  // Add selected siblings
  const selectedSiblings = document.querySelectorAll('.sibling-checkbox:checked');
  selectedSiblings.forEach(checkbox => {
    codeFormData.append('additional_kid_ids', checkbox.value);
  });
  
  fetch(`/checkout/${currentCheckoutData.kidId}`, {
    method: 'POST',
    headers: {
      'X-Requested-With': 'XMLHttpRequest'
    },
    body: codeFormData
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      bootstrap.Modal.getInstance(document.getElementById('checkoutCodeModal')).hide();
      location.reload();
    } else if (data.code_required) {
      // Code is required but wasn't provided or was invalid
      const input = document.getElementById('checkout-code-input');
      input.classList.add('is-invalid');
      input.value = '';
      input.placeholder = data.message || 'Code required - please enter';
      input.focus();
      setTimeout(() => {
        input.classList.remove('is-invalid');
        input.placeholder = 'Code';
      }, 2000);
    } else {
      // Other error
      const input = document.getElementById('checkout-code-input');
      input.classList.add('is-invalid');
      input.value = '';
      input.placeholder = data.message || 'Checkout failed';
      setTimeout(() => {
        input.classList.remove('is-invalid');
        input.placeholder = 'Code';
      }, 2000);
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Network error during checkout');
  });
});

// Enable Bootstrap tooltips
document.addEventListener('DOMContentLoaded', function() {
  var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
  var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl);
  });
});

// Helper function to populate family modal with data
function populateFamilyModal(data) {
  document.getElementById('modal-phone').textContent = data.phone;
  document.getElementById('modal-troop').textContent = data.troop || '‚Äî';
  document.getElementById('family-id').value = data.family_id;
  
  const adultSelect = document.getElementById('adult-select');
  adultSelect.innerHTML = '<option value="">Select Adult</option>';
  data.adults.forEach((adult, index) => {
    const option = document.createElement('option');
    option.value = adult.id;
    option.textContent = adult.name;
    const isSelected = data.default_adult_id ? adult.id === data.default_adult_id : index === 0;
    if (isSelected) option.selected = true;
    adultSelect.appendChild(option);
  });
  
  const kidsList = document.getElementById('kids-list');
  kidsList.innerHTML = '';
  
  // Auto-select kids for families with only one kid
  const availableKids = data.kids.filter(kid => !kid.already_checked_in);
  const autoSelect = availableKids.length === 1;
  
  data.kids.forEach(kid => {
    const div = document.createElement('div');
    div.className = 'form-check';
    const isCheckedIn = kid.already_checked_in;
    const checkedInLabel = isCheckedIn ? ' <span class="badge bg-success">Already Checked In</span>' : '';
    const shouldCheck = !isCheckedIn && autoSelect;
    div.innerHTML = `
      <input class="form-check-input" type="checkbox" name="kid_ids" value="${kid.id}" id="kid-${kid.id}" ${isCheckedIn ? 'disabled checked' : shouldCheck ? 'checked' : ''}>
      <label class="form-check-label" for="kid-${kid.id}" style="${isCheckedIn ? 'opacity: 0.6;' : ''}">${kid.name}${checkedInLabel}</label>
    `;
    kidsList.appendChild(div);
  });
}

// Helper function to show multiple families in results modal
function showMultipleFamilies(families) {
  const list = document.getElementById('name-results-list');
  list.innerHTML = '';
  
  families.forEach((f, idx) => {
    const div = document.createElement('div');
    div.className = 'border rounded p-3 mb-3';
    div.style.cursor = 'pointer';
    div.style.transition = 'all 0.2s';
    
    // Hover effect
    div.addEventListener('mouseenter', function() {
      this.style.backgroundColor = '#f8f9fa';
      this.style.borderColor = '{{ branding.primary_color }}';
      this.style.borderWidth = '2px';
    });
    div.addEventListener('mouseleave', function() {
      this.style.backgroundColor = '';
      this.style.borderColor = '';
      this.style.borderWidth = '';
    });
    
    // Handle kids
    let kids = 'None';
    if (f.kids && Array.isArray(f.kids) && f.kids.length > 0) {
      kids = f.kids.map(k => {
        const badge = k.already_checked_in ? ' <span class="badge bg-success">Checked In</span>' : '';
        return k.name + badge;
      }).join(', ');
    }
    
    // Handle adults
    let adults = 'None';
    if (f.adults && Array.isArray(f.adults) && f.adults.length > 0) {
      adults = f.adults.map(a => a.name).join(', ');
    }
    
    div.innerHTML = `
      <div class="d-flex justify-content-between align-items-start mb-2">
        <div>
          <h6 class="mb-1"><strong>Phone:</strong> ${f.phone || 'N/A'}</h6>
          ${f.troop ? '<div class="text-muted"><strong>Troop:</strong> ' + f.troop + '</div>' : ''}
        </div>
        <button class="btn btn-sm btn-primary select-family" data-idx="${idx}">Select</button>
      </div>
      <div class="mb-1"><strong>Kids:</strong> ${kids || 'None'}</div>
      <div class="text-muted"><strong>Adults:</strong> ${adults || 'None'}</div>
    `;
    
    // Click anywhere on the card to select
    div.addEventListener('click', function(e) {
      if (!e.target.classList.contains('select-family')) {
        div.querySelector('.select-family').click();
      }
    });
    
    list.appendChild(div);
  });
  
  // Attach handlers to select buttons
  Array.from(list.querySelectorAll('.select-family')).forEach(btn => {
    btn.addEventListener('click', function(e) {
      e.stopPropagation();
      const idx = parseInt(this.dataset.idx, 10);
      const f = families[idx];
      populateFamilyModal(f);
      bootstrap.Modal.getInstance(document.getElementById('nameResultsModal')).hide();
      new bootstrap.Modal(document.getElementById('familyModal')).show();
    });
  });
  
  new bootstrap.Modal(document.getElementById('nameResultsModal')).show();
}


</script>
<script src="/static/dymo_print.js"></script>
{% endblock %}
