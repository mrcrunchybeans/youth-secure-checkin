{% extends 'base.html' %}
{% block content %}
<style>
  @media (max-width: 768px) {
    .card-header {
      padding: 0.5rem 0.75rem;
      font-size: 0.95rem;
    }
    .event-select-mobile {
      max-width: 150px !important;
      font-size: 0.8rem;
    }
    #checkin-form .col-auto {
      width: 100%;
    }
    #checkin-form button {
      width: 100%;
      margin-top: 0.5rem;
    }
    .list-group-item {
      flex-direction: column;
      align-items: flex-start !important;
    }
    .list-group-item form {
      width: 100%;
      margin-top: 0.5rem;
    }
    .list-group-item form button {
      width: 100%;
    }
  }
</style>
<div class="row">
  <div class="col-lg-8 col-12">
    <div class="card mb-3">
      <div class="card-header d-flex justify-content-between align-items-center flex-wrap" style="background-color: #79060d; color: white;">
        <strong class="mb-1 mb-sm-0">Family Lookup</strong>
        <!-- Desktop: dropdown select -->
        <select id="event-select" class="form-select form-select-sm d-none d-sm-inline-block" style="width: auto; max-width: 300px;">
          {% for event in events %}
            <option value="{{ event['id'] }}" {% if event['id'] == current_event_id %}selected{% endif %}>{{ event['start_time'][:10] }} - {{ event['name'] }}</option>
          {% endfor %}
        </select>
        <!-- Mobile: button opens modal -->
        <button type="button" class="btn btn-sm btn-light d-inline d-sm-none" data-bs-toggle="modal" data-bs-target="#eventModalIndex" style="padding: 0.25rem 0.75rem; font-size: 1.2rem;" title="Select Event">
          &#128197;
        </button>
      </div>
      <div class="card-body">
        <form id="checkin-form" class="row g-3 align-items-end">
          <input type="hidden" id="event-id" name="event_id" value="{{ current_event_id }}">
          <div class="col-auto col-md-8" style="flex: 1;">
            <label class="form-label fw-bold">Last 4 Digits of Phone</label>
            <input id="last4" class="form-control" maxlength="4" pattern="\d{4}" required placeholder="0000" inputmode="numeric" />
          </div>
          <div class="col-auto col-md-4">
            <button type="submit" class="btn" style="background-color: #79060d; color: white; border: none; padding: 0.5rem 2rem;">Search</button>
          </div>
        </form>
      </div>
    </div>

    <div class="card">
      <div class="card-header" style="background-color: #4a582d; color: white;"><strong>Currently Checked In - {{ checked_in|length }}</strong></div>
      <ul class="list-group list-group-flush" style="max-height: 500px; overflow-y: auto;">
        {% for row in checked_in %}
          <li class="list-group-item d-flex justify-content-between align-items-center py-2">
            <div style="flex: 1;">
              <div>
                <strong style="font-size: 1.1rem;">{{ row['kid_name'] }}</strong>
                {% if row['kid_notes'] %}
                  <span class="text-muted ms-1" style="cursor: pointer; font-size: 0.7rem; opacity: 0.6;" 
                        data-bs-toggle="tooltip" data-bs-placement="top" data-bs-html="true"
                        title="{{ row['kid_notes'] | replace('\n', '<br>') }}">‚ÑπÔ∏è</span>
                {% endif %}
                {% if row['authorized_adults'] %}
                  <span class="text-muted ms-1" style="cursor: pointer; font-size: 0.7rem; opacity: 0.6;" 
                        data-bs-toggle="tooltip" data-bs-placement="top" data-bs-html="true"
                        title="<strong>Authorized for Checkout:</strong><br>{{ row['authorized_adults'] | replace('\n', '<br>') }}">üë§</span>
                {% endif %}
                <span class="text-muted d-block d-sm-inline">‚Äî {{ row['adult_name'] }}</span>
              </div>
              <small class="text-muted d-block">Phone: {{ row['phone'] }} ¬∑ {{ row['formatted_time'] }}</small>
            </div>
            <button class="btn btn-sm checkout-btn" style="color: #79060d; border-color: #79060d; white-space: nowrap;" 
                    data-kid-id="{{ row['kid_id'] }}" 
                    data-kid-name="{{ row['kid_name'] }}" 
                    data-event-id="{{ current_event_id }}">Check Out</button>
          </li>
        {% else %}
          <li class="list-group-item text-muted text-center py-4">No one is currently checked in.</li>
        {% endfor %}
      </ul>
    </div>
  </div>

  <div class="col-lg-4 col-12 mt-3 mt-lg-0">
    <div class="card mb-3">
      <div class="card-header" style="background-color: #003b59; color: white;"><strong>Quick Actions</strong></div>
      <div class="card-body">
        <div class="d-grid gap-2">
          <a href="/kiosk" class="btn" style="background-color: #79060d; color: white; border: none;">
            <span style="font-size: 1.2rem;">üì±</span> Kiosk Mode
          </a>
          <a href="/admin" class="btn" style="background-color: #003b59; color: white; border: none;">
            <span style="font-size: 1.2rem;">‚öôÔ∏è</span> Admin Panel
          </a>
          <a href="/history" class="btn btn-outline-secondary">
            <span style="font-size: 1.2rem;">üìã</span> View History
          </a>
        </div>
      </div>
    </div>

    <div class="card d-none d-lg-block">
      <div class="card-header"><strong>About</strong></div>
      <div class="card-body">
        <p class="small mb-2">This system supports family-based check-in using the last 4 digits of phone numbers.</p>
        <p class="small mb-0 text-muted">Configure families, adults, kids, and events in the Admin panel.</p>
      </div>
    </div>
  </div>
</div>

<!-- Mobile event selector modal -->
<div class="modal fade" id="eventModalIndex" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header" style="background-color: #79060d; color: white;">
        <h5 class="modal-title">Select Event</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" style="max-height:60vh; overflow-y:auto;">
        <div class="list-group">
          {% for event in events %}
          <a href="/?event_id={{ event['id'] }}" class="list-group-item list-group-item-action {% if event['id'] == current_event_id %}active{% endif %}">
            {{ event['start_time'][:10] }} ‚Äî {{ event['name'] }}
          </a>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal -->
<div class="modal fade" id="familyModal" tabindex="-1" aria-labelledby="familyModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header" style="background-color: #79060d; color: white;">
        <h5 class="modal-title" id="familyModalLabel">Select Kids to Check In</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p><strong>Phone:</strong> <span id="modal-phone"></span></p>
        <p><strong>Troop:</strong> <span id="modal-troop"></span></p>
        <form id="select-kids-form">
          <input type="hidden" id="family-id" name="family_id">
          <input type="hidden" id="modal-event-id" name="event_id" value="{{ current_event_id }}">
          <div class="mb-3">
            <label class="form-label">Checking in as:</label>
            <select name="adult_id" id="adult-select" class="form-select" required>
              <option value="">Select Adult</option>
            </select>
          </div>
          <div id="kids-list"></div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn" style="background-color: #003b59; color: white; border: none;" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" form="select-kids-form" class="btn" style="background-color: #4a582d; color: white; border: none;">Check In Selected</button>
      </div>
    </div>
  </div>
</div>

<!-- QR Code Modal -->
<div class="modal fade" id="qrCodeModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered" style="max-width: 420px;">
    <div class="modal-content" style="border-radius: 15px; overflow: hidden; border: 3px solid #79060d;">
      <div class="modal-header" style="background: linear-gradient(135deg, #79060d 0%, #003b59 100%); color: white; border: none; padding: 1rem;">
        <h5 class="modal-title" style="font-size: 1.3rem; font-weight: 700;">üì± Scan for Checkout Code</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center" style="padding: 1.5rem;">
        <img id="qr-code-img" src="" alt="QR Code" style="max-width: 250px; width: 100%; border: 5px solid #f8f9fa; border-radius: 10px;">
        <div class="mt-3 mb-2" style="background: #f8f9fa; border: 2px solid #79060d; border-radius: 10px; padding: 0.8rem;">
          <div class="text-muted mb-1" style="font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05rem;">Checkout Code</div>
          <div id="qr-code-text" style="font-size: 1.8rem; font-weight: bold; color: #79060d; font-family: 'Courier New', monospace; letter-spacing: 0.3rem;"></div>
        </div>
        <p class="text-muted mb-0" style="font-size: 0.85rem; line-height: 1.4;">Scan QR code or write down the code above</p>
      </div>
      <div class="modal-footer" style="border: none; justify-content: center; padding: 1rem 1.5rem;">
        <button type="button" class="btn" style="background: linear-gradient(135deg, #79060d 0%, #003b59 100%); color: white; border: none; border-radius: 10px; padding: 0.6rem 2rem; font-size: 1.1rem; font-weight: 600;" data-bs-dismiss="modal">Done</button>
      </div>
    </div>
  </div>
</div>

<!-- Checkout Code Entry Modal -->
<div class="modal fade" id="checkoutCodeModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered" style="max-width: 380px;">
    <div class="modal-content" style="border-radius: 15px; overflow: hidden; border: 3px solid #79060d;">
      <div class="modal-header" style="background: linear-gradient(135deg, #79060d 0%, #003b59 100%); color: white; border: none; padding: 0.6rem 0.9rem;">
        <h5 class="modal-title" style="font-size: 1.15rem; font-weight: 700;">üîí Enter Code</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" style="padding: 0.9rem;">
        <p class="text-center mb-2" style="font-size: 0.95rem; font-weight: 600; color: #333;" id="checkout-kid-name"></p>
        
        <!-- Siblings section -->
        <div id="siblings-section" style="display: none;">
          <div class="mb-2" style="padding: 0.6rem; background: #f8f9fa; border-radius: 8px; border: 1px solid #dee2e6;">
            <div class="text-muted mb-1" style="font-size: 0.8rem; font-weight: 600;">Also check out:</div>
            <div id="siblings-list"></div>
          </div>
        </div>
        
        <form id="checkout-code-form">
          <div class="mb-2">
            <input type="text" class="form-control text-center" id="checkout-code-input" 
                   style="font-size: 1.5rem; letter-spacing: 0.3rem; font-family: 'Courier New', monospace; border: 2px solid #79060d; font-weight: bold; padding: 0.4rem;"
                   maxlength="10" required autocomplete="off" inputmode="none" placeholder="Code">
          </div>
          
          <!-- On-screen keypad -->
          <div id="checkout-keypad" class="mb-2">
            <div class="d-grid" style="grid-template-columns: repeat(3, 1fr); gap: 0.4rem; display: grid;">
              <button type="button" class="btn btn-outline-secondary checkout-key" data-value="1" style="font-size: 1.25rem; padding: 0.45rem; font-weight: 600;">1</button>
              <button type="button" class="btn btn-outline-secondary checkout-key" data-value="2" style="font-size: 1.25rem; padding: 0.45rem; font-weight: 600;">2</button>
              <button type="button" class="btn btn-outline-secondary checkout-key" data-value="3" style="font-size: 1.25rem; padding: 0.45rem; font-weight: 600;">3</button>
              <button type="button" class="btn btn-outline-secondary checkout-key" data-value="4" style="font-size: 1.25rem; padding: 0.45rem; font-weight: 600;">4</button>
              <button type="button" class="btn btn-outline-secondary checkout-key" data-value="5" style="font-size: 1.25rem; padding: 0.45rem; font-weight: 600;">5</button>
              <button type="button" class="btn btn-outline-secondary checkout-key" data-value="6" style="font-size: 1.25rem; padding: 0.45rem; font-weight: 600;">6</button>
              <button type="button" class="btn btn-outline-secondary checkout-key" data-value="7" style="font-size: 1.25rem; padding: 0.45rem; font-weight: 600;">7</button>
              <button type="button" class="btn btn-outline-secondary checkout-key" data-value="8" style="font-size: 1.25rem; padding: 0.45rem; font-weight: 600;">8</button>
              <button type="button" class="btn btn-outline-secondary checkout-key" data-value="9" style="font-size: 1.25rem; padding: 0.45rem; font-weight: 600;">9</button>
              <button type="button" class="btn btn-outline-danger" id="checkout-keypad-clear" style="font-size: 0.95rem; padding: 0.45rem; font-weight: 600;">Clear</button>
              <button type="button" class="btn btn-outline-secondary checkout-key" data-value="0" style="font-size: 1.25rem; padding: 0.45rem; font-weight: 600;">0</button>
              <button type="button" class="btn btn-outline-warning" id="checkout-keypad-back" style="font-size: 0.95rem; padding: 0.45rem; font-weight: 600;">‚Üê</button>
            </div>
          </div>
          
          <div class="d-grid" style="gap: 0.4rem;">
            <button type="submit" class="btn" style="background: linear-gradient(135deg, #4a582d 0%, #79060d 100%); color: white; border: none; border-radius: 10px; padding: 0.55rem; font-size: 1.05rem; font-weight: 600;">
              ‚úì Check Out
            </button>
            <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal" style="border-radius: 10px; padding: 0.35rem;">
              Cancel
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
function showQRCodeModal(qrCodeData, checkoutCode) {
  document.getElementById('qr-code-img').src = qrCodeData;
  document.getElementById('qr-code-text').textContent = checkoutCode || '';
  new bootstrap.Modal(document.getElementById('qrCodeModal')).show();
}

document.getElementById('event-select').addEventListener('change', function() {
  const eventId = this.value;
  window.location.href = `/?event_id=${eventId}`;
});

document.getElementById('checkin-form').addEventListener('submit', function(e) {
  e.preventDefault();
  const last4 = document.getElementById('last4').value;
  const eventId = document.getElementById('event-id').value;
  fetch('/checkin_last4', {
    method: 'POST',
    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
    body: new URLSearchParams({last4: last4, event_id: eventId})
  })
  .then(response => response.json())
  .then(data => {
    if (data.error) {
      alert(data.error);
      return;
    }
    document.getElementById('modal-phone').textContent = data.phone;
    document.getElementById('modal-troop').textContent = data.troop || '‚Äî';
    document.getElementById('family-id').value = data.family_id;
    const adultSelect = document.getElementById('adult-select');
    adultSelect.innerHTML = '<option value="">Select Adult</option>';
    data.adults.forEach((adult, index) => {
      const option = document.createElement('option');
      option.value = adult.id;
      option.textContent = adult.name;
      // Select the default adult if specified, otherwise select the first one
      const isSelected = data.default_adult_id ? adult.id === data.default_adult_id : index === 0;
      if (isSelected) option.selected = true;
      adultSelect.appendChild(option);
    });
    const kidsList = document.getElementById('kids-list');
    kidsList.innerHTML = '';
    data.kids.forEach(kid => {
      const div = document.createElement('div');
      div.className = 'form-check';
      const isCheckedIn = kid.already_checked_in;
      const checkedInLabel = isCheckedIn ? ' <span class="badge bg-success">Already Checked In</span>' : '';
      div.innerHTML = `
        <input class="form-check-input" type="checkbox" name="kid_ids" value="${kid.id}" id="kid-${kid.id}" ${isCheckedIn ? 'disabled checked' : ''}>
        <label class="form-check-label" for="kid-${kid.id}" style="${isCheckedIn ? 'opacity: 0.6;' : ''}">${kid.name}${checkedInLabel}</label>
      `;
      kidsList.appendChild(div);
    });
    new bootstrap.Modal(document.getElementById('familyModal')).show();
  })
  .catch(error => console.error('Error:', error));
});

document.getElementById('select-kids-form').addEventListener('submit', function(e) {
  e.preventDefault();
  const formData = new FormData(this);
  fetch('/checkin_selected', {
    method: 'POST',
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    bootstrap.Modal.getInstance(document.getElementById('familyModal')).hide();
    
    // Show QR code if available
    if (data.qr_code) {
      showQRCodeModal(data.qr_code, data.checkout_code);
    }
    
    // Print labels if any were returned (deferred to prevent UI blocking)
    if (data.labels && data.labels.length > 0) {
      data.labels.forEach(label => {
        setTimeout(() => {
          printDymoLabel(
            label.kid_name,
            label.event_name,
            label.event_date,
            label.checkin_time,
            label.checkout_code
          );
        }, 0);
      });
    }
    
    // Add check-ins to the page dynamically
    if (data.checkins && data.checkins.length > 0) {
      const checkedInDiv = document.getElementById('checked-in-list');
      const eventId = document.querySelector('[name="event_id"]').value;
      
      data.checkins.forEach(checkin => {
        const card = document.createElement('div');
        card.className = 'card mb-2';
        card.innerHTML = `
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <h5 class="card-title mb-1">${checkin.kid_name}
                  ${checkin.kid_notes ? '<i class="bi bi-sticky text-muted" style="font-size: 0.7rem; opacity: 0.6;" data-bs-toggle="tooltip" title="' + checkin.kid_notes + '">üìã</i>' : ''}
                  ${checkin.authorized_adults ? '<i class="bi bi-person-check text-muted" style="font-size: 0.7rem; opacity: 0.6;" data-bs-toggle="tooltip" title="Authorized: ' + checkin.authorized_adults + '">üë§</i>' : ''}
                </h5>
                <p class="card-text mb-0">
                  <small class="text-muted">
                    <strong>${checkin.adult_name}</strong> ‚Ä¢ ${checkin.phone}<br>
                    ${checkin.formatted_time}
                  </small>
                </p>
              </div>
              <button class="btn btn-danger btn-sm checkout-btn" 
                      data-kid-id="${checkin.kid_id}" 
                      data-kid-name="${checkin.kid_name}"
                      data-event-id="${eventId}">Check Out</button>
            </div>
          </div>
        `;
        checkedInDiv.insertBefore(card, checkedInDiv.firstChild);
        
        // Initialize tooltips for this card
        const tooltips = card.querySelectorAll('[data-bs-toggle="tooltip"]');
        tooltips.forEach(el => new bootstrap.Tooltip(el));
      });
      
      // Update count in header
      const countBadge = document.querySelector('h2 .badge');
      if (countBadge) {
        const currentCount = parseInt(countBadge.textContent) || 0;
        countBadge.textContent = currentCount + data.checkins.length;
      }
    }
    
    // Show success message
    if (data.message) {
      const alert = document.createElement('div');
      alert.className = 'alert alert-success alert-dismissible fade show';
      alert.innerHTML = `
        ${data.message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      `;
      document.querySelector('.container').insertBefore(alert, document.querySelector('.container').firstChild);
      setTimeout(() => alert.remove(), 3000);
    }
  })
  .catch(error => console.error('Error:', error));
});

// Handle checkout with code verification
let currentCheckoutData = null;

document.addEventListener('click', function(e) {
  if (e.target.classList.contains('checkout-btn')) {
    const kidId = e.target.dataset.kidId;
    const kidName = e.target.dataset.kidName;
    const eventId = e.target.dataset.eventId;
    
    // Store data for later use
    currentCheckoutData = { kidId, kidName, eventId };
    
    // First, fetch siblings to show in modal
    const siblingFormData = new FormData();
    siblingFormData.append('event_id', eventId);
    
    fetch(`/get_siblings/${kidId}`, {
      method: 'POST',
      body: siblingFormData
    })
    .then(response => response.json())
    .then(siblingData => {
      console.log('Siblings response:', siblingData);
      // Store sibling data for use in form submission
      currentCheckoutData.siblings = (siblingData.success && siblingData.siblings) ? siblingData.siblings : [];
      
      // If there are siblings, always show the modal to allow selection
      if (currentCheckoutData.siblings.length > 0) {
        // Show modal with siblings for checkout
        document.getElementById('checkout-kid-name').textContent = kidName;
        document.getElementById('checkout-code-input').value = '';
        
        // Show siblings section
        const siblingsSection = document.getElementById('siblings-section');
        const siblingsList = document.getElementById('siblings-list');
        siblingsList.innerHTML = '';
        currentCheckoutData.siblings.forEach(sibling => {
          const div = document.createElement('div');
          div.className = 'form-check';
          div.innerHTML = `
            <input class="form-check-input sibling-checkbox" type="checkbox" value="${sibling.kid_id}" id="sib-${sibling.kid_id}">
            <label class="form-check-label" for="sib-${sibling.kid_id}" style="font-size: 0.9rem;">${sibling.name}</label>
          `;
          siblingsList.appendChild(div);
        });
        siblingsSection.style.display = 'block';
        
        const modal = new bootstrap.Modal(document.getElementById('checkoutCodeModal'));
        modal.show();
        // Focus input after modal is shown
        document.getElementById('checkoutCodeModal').addEventListener('shown.bs.modal', function() {
          document.getElementById('checkout-code-input').focus();
        }, { once: true });
      } else {
        // No siblings, proceed with normal checkout flow
        const formData = new FormData();
        formData.append('event_id', eventId);
        
        fetch(`/checkout/${kidId}`, {
          method: 'POST',
          headers: {
            'X-Requested-With': 'XMLHttpRequest'
          },
          body: formData
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            location.reload();
          } else if (data.code_required) {
            // Show modal for checkout code
            document.getElementById('checkout-kid-name').textContent = kidName;
            document.getElementById('checkout-code-input').value = '';
            document.getElementById('siblings-section').style.display = 'none';
            
            const modal = new bootstrap.Modal(document.getElementById('checkoutCodeModal'));
            modal.show();
            // Focus input after modal is shown
            document.getElementById('checkoutCodeModal').addEventListener('shown.bs.modal', function() {
              document.getElementById('checkout-code-input').focus();
            }, { once: true });
          } else {
            alert(data.message || 'Checkout failed');
          }
        })
        .catch(error => console.error('Error:', error));
      }
    })
    .catch(error => console.error('Error fetching siblings:', error));
  }
});

// Checkout code keypad handlers
document.addEventListener('DOMContentLoaded', function() {
  const checkoutInput = document.getElementById('checkout-code-input');
  const checkoutKeys = document.querySelectorAll('.checkout-key');
  const checkoutBack = document.getElementById('checkout-keypad-back');
  const checkoutClear = document.getElementById('checkout-keypad-clear');
  
  checkoutKeys.forEach(key => {
    key.addEventListener('click', function() {
      const value = this.dataset.value;
      if (checkoutInput.value.length < 10) {
        checkoutInput.value += value;
      }
    });
  });
  
  if (checkoutBack) {
    checkoutBack.addEventListener('click', function() {
      checkoutInput.value = checkoutInput.value.slice(0, -1);
    });
  }
  
  if (checkoutClear) {
    checkoutClear.addEventListener('click', function() {
      checkoutInput.value = '';
    });
  }
});

// Handle checkout code form submission
document.getElementById('checkout-code-form').addEventListener('submit', function(e) {
  e.preventDefault();
  
  if (!currentCheckoutData) return;
  
  const code = document.getElementById('checkout-code-input').value.trim();
  
  const codeFormData = new FormData();
  codeFormData.append('event_id', currentCheckoutData.eventId);
  if (code) {
    codeFormData.append('checkout_code', code);
  }
  
  // Add selected siblings
  const selectedSiblings = document.querySelectorAll('.sibling-checkbox:checked');
  selectedSiblings.forEach(checkbox => {
    codeFormData.append('additional_kid_ids', checkbox.value);
  });
  
  fetch(`/checkout/${currentCheckoutData.kidId}`, {
    method: 'POST',
    headers: {
      'X-Requested-With': 'XMLHttpRequest'
    },
    body: codeFormData
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      bootstrap.Modal.getInstance(document.getElementById('checkoutCodeModal')).hide();
      location.reload();
    } else if (data.code_required) {
      // Code is required but wasn't provided or was invalid
      const input = document.getElementById('checkout-code-input');
      input.classList.add('is-invalid');
      input.value = '';
      input.placeholder = data.message || 'Code required - please enter';
      input.focus();
      setTimeout(() => {
        input.classList.remove('is-invalid');
        input.placeholder = 'Code';
      }, 2000);
    } else {
      // Other error
      const input = document.getElementById('checkout-code-input');
      input.classList.add('is-invalid');
      input.value = '';
      input.placeholder = data.message || 'Checkout failed';
      setTimeout(() => {
        input.classList.remove('is-invalid');
        input.placeholder = 'Code';
      }, 2000);
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Network error during checkout');
  });
});

// Enable Bootstrap tooltips
document.addEventListener('DOMContentLoaded', function() {
  var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
  var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl);
  });
});
</script>
<script src="/static/dymo_print.js"></script>
{% endblock %}
