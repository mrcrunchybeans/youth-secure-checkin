{% extends "base.html" %}

{% block title %}Check-in Kiosk | {{ current_event_name }} - {{ current_event_date }}{% endblock %}

{% block navbar_buttons %}
<button id="fullscreen-btn-nav" class="btn btn-outline-light btn-sm me-2" style="font-size: 1.5rem; padding: 0.25rem 0.5rem; line-height: 1;">&#9974;</button>
<div class="d-inline-block">
    <!-- Desktop/tablet: Bootstrap dropdown -->
    <div class="dropdown d-none d-sm-inline-block">
        <button class="btn btn-outline-light btn-sm dropdown-toggle me-2" type="button" id="eventDropdownNav" data-bs-toggle="dropdown" aria-expanded="false" title="{{ current_event_name }}" style="font-size: 1.5rem; padding: 0.25rem 0.5rem; line-height: 1;">
            &#128197;
        </button>
        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="eventDropdownNav">
            {% for event in events %}
            <li><a class="dropdown-item" href="{{ url_for('kiosk', event_id=event.id) }}">{{ event.name }} - {{ event.formatted_start }}</a></li>
            {% endfor %}
        </ul>
    </div>
    <!-- Mobile: open a modal with events (prevents dropdown cutoff) -->
    <button class="btn btn-outline-light btn-sm d-inline d-sm-none me-2" type="button" id="eventModalBtn" data-bs-toggle="modal" data-bs-target="#eventModal" title="{{ current_event_name }}" style="font-size: 1.5rem; padding: 0.25rem 0.5rem; line-height: 1;">
        &#128197;
    </button>
</div>
<a class="btn btn-outline-light btn-sm" href="/history" title="History" style="font-size: 1.5rem; padding: 0.25rem 0.5rem; line-height: 1;">üìã</a>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            {% if logo_filename %}
            <div class="text-center mb-3">
                <img src="{{ url_for('static', filename='uploads/' + logo_filename) }}" alt="Logo" style="max-height: 80px; max-width: 100%;">
            </div>
            {% endif %}
            
            <h1 class="text-center mb-1" style="font-size: 2rem;">Check-in Kiosk</h1>
            <p class="text-center mb-2" style="font-size: 1rem; color: #666; font-weight: normal;">{{ current_event_name }} - {{ current_event_date }}</p>

            <!-- Check-in Form -->
            <div class="card mb-2">
                <div class="card-body" style="padding: 1rem;">
                    <h3 class="card-title" style="font-size: 1.5rem; margin-bottom: 1rem;">Family Lookup</h3>
                    <form id="checkin-form">
                        <input type="hidden" id="event-id" value="{{ current_event_id }}">
                        <div class="mb-2">
                            <label for="phone" class="form-label" style="font-size: 1.1rem; margin-bottom: 0.5rem;">Last 4 digits of phone number:</label>
                            <input type="tel" inputmode="numeric" class="form-control" id="phone" name="phone" maxlength="4" pattern="\d{4}" required style="font-size: 1.5rem; padding: 0.6rem; height: auto;" aria-label="Last four digits">
                        </div>

                        <!-- On-screen numeric keypad for touch screens -->
                        <div id="keypad" class="mb-2" style="max-width: 350px; margin: 0 auto;">
                            <div class="d-grid gap-1" style="grid-template-columns: repeat(3, 1fr); display: grid;">
                                <button type="button" class="btn btn-light keypad-key" data-value="1" style="font-size: 1.2rem; padding: 0.5rem;">1</button>
                                <button type="button" class="btn btn-light keypad-key" data-value="2" style="font-size: 1.2rem; padding: 0.5rem;">2</button>
                                <button type="button" class="btn btn-light keypad-key" data-value="3" style="font-size: 1.2rem; padding: 0.5rem;">3</button>
                                <button type="button" class="btn btn-light keypad-key" data-value="4" style="font-size: 1.2rem; padding: 0.5rem;">4</button>
                                <button type="button" class="btn btn-light keypad-key" data-value="5" style="font-size: 1.2rem; padding: 0.5rem;">5</button>
                                <button type="button" class="btn btn-light keypad-key" data-value="6" style="font-size: 1.2rem; padding: 0.5rem;">6</button>
                                <button type="button" class="btn btn-light keypad-key" data-value="7" style="font-size: 1.2rem; padding: 0.5rem;">7</button>
                                <button type="button" class="btn btn-light keypad-key" data-value="8" style="font-size: 1.2rem; padding: 0.5rem;">8</button>
                                <button type="button" class="btn btn-light keypad-key" data-value="9" style="font-size: 1.2rem; padding: 0.5rem;">9</button>
                                <button type="button" id="keypad-clear" class="btn btn-outline-secondary" style="font-size: 1rem; padding: 0.5rem;">Clear</button>
                                <button type="button" class="btn btn-light keypad-key" data-value="0" style="font-size: 1.2rem; padding: 0.5rem;">0</button>
                                <button type="button" id="keypad-back" class="btn btn-outline-secondary" style="font-size: 1rem; padding: 0.5rem;">‚å´</button>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-lg w-100" id="search-btn" style="font-size: 1.3rem; padding: 0.6rem; margin-top: 0.5rem; background-color: #79060d; color: white; border: none;">Search</button>
                    </form>
                </div>
            </div>

            <!-- Currently Checked In -->
            <div class="card">
                <div class="card-body" style="padding: 1rem;">
                    <h3 class="card-title" style="font-size: 1.5rem; margin-bottom: 1rem;">Currently Checked In</h3>
                    <div class="table-responsive" style="max-height: 350px; overflow-y: auto;">
                        <table class="table table-striped table-sm" style="font-size: 0.9rem;">
                            <thead style="font-size: 1rem; position: sticky; top: 0; background: white;">
                                <tr>
                                    <th>Kid Name</th>
                                    <th>Phone</th>
                                    <th>Adult</th>
                                    <th>Time</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="checked-in-list">
                                {% for checkin in checked_in %}
                                <tr style="height: 2rem;">
                                    <td style="vertical-align: middle;">
                                        {{ checkin.kid_name }}
                                        {% if checkin.kid_notes %}
                                          <span class="text-muted ms-1" style="cursor: pointer; font-size: 0.65rem; opacity: 0.6;" 
                                                data-bs-toggle="tooltip" data-bs-placement="top" data-bs-html="true"
                                                title="{{ checkin.kid_notes | replace('\n', '<br>') }}">‚ÑπÔ∏è</span>
                                        {% endif %}
                                        {% if checkin.authorized_adults %}
                                          <span class="text-muted ms-1" style="cursor: pointer; font-size: 0.65rem; opacity: 0.6;" 
                                                data-bs-toggle="tooltip" data-bs-placement="top" data-bs-html="true"
                                                title="<strong>Authorized for Checkout:</strong><br>{{ checkin.authorized_adults | replace('\n', '<br>') }}">üë§</span>
                                        {% endif %}
                                    </td>
                                    <td style="vertical-align: middle;">{{ checkin.phone }}</td>
                                    <td style="vertical-align: middle;">{{ checkin.adult_name }}</td>
                                    <td style="vertical-align: middle; font-size: 0.8rem;">{{ checkin.formatted_time }}</td>
                                    <td style="vertical-align: middle;">
                                        <button class="btn btn-warning btn-sm checkout-btn" style="font-size: 0.75rem; padding: 0.15rem 0.35rem;"
                                                data-kid-id="{{ checkin.kid_id }}"
                                                data-kid-name="{{ checkin.kid_name }}"
                                                data-event-id="{{ current_event_id }}">Check-Out</button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
                    <!-- Mobile event selector modal (prevents dropdown cutoff) -->
                    <div class="modal fade" id="eventModal" tabindex="-1">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content">
                                <div class="modal-header" style="background-color: #79060d; color: white;">
                                    <h5 class="modal-title">Select Event</h5>
                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body" style="max-height:60vh; overflow-y:auto;">
                                    <div class="list-group">
                                        {% for event in events %}
                                        <a href="{{ url_for('kiosk', event_id=event.id) }}" class="list-group-item list-group-item-action">{{ event.formatted_start }} ‚Äî {{ event.name }}</a>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Modal for Family Selection -->
<div class="modal fade" id="familyModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header" style="padding: 1.5rem; background-color: #79060d; color: white;">
                <h5 class="modal-title" style="font-size: 1.8rem;">Select Family Members</h5>
                <button type="button" class="btn-close btn-close-white" style="font-size: 1.5rem;" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modal-body" style="padding: 1.5rem; font-size: 1.2rem; max-height: 60vh; overflow-y: auto;">
                <!-- Family data will be loaded here -->
            </div>
        </div>
    </div>
</div>

<!-- QR Code Modal -->
<div class="modal fade" id="qrCodeModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered" style="max-width: 420px;">
    <div class="modal-content" style="border-radius: 15px; overflow: hidden; border: 3px solid #79060d;">
      <div class="modal-header" style="background: linear-gradient(135deg, #79060d 0%, #003b59 100%); color: white; border: none; padding: 1rem;">
        <h5 class="modal-title" style="font-size: 1.3rem; font-weight: 700;">üì± Scan for Checkout Code</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center" style="padding: 1.5rem;">
        <img id="qr-code-img" src="" alt="QR Code" style="max-width: 250px; width: 100%; border: 5px solid #f8f9fa; border-radius: 10px;">
        <div class="mt-3 mb-2" style="background: #f8f9fa; border: 2px solid #79060d; border-radius: 10px; padding: 0.8rem;">
          <div class="text-muted mb-1" style="font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05rem;">Checkout Code</div>
          <div id="qr-code-text" style="font-size: 1.8rem; font-weight: bold; color: #79060d; font-family: 'Courier New', monospace; letter-spacing: 0.3rem;"></div>
        </div>
        <p class="text-muted mb-0" style="font-size: 0.85rem; line-height: 1.4;">Scan QR code or write down the code above</p>
      </div>
      <div class="modal-footer" style="border: none; justify-content: center; padding: 1rem 1.5rem;">
        <button type="button" class="btn" style="background: linear-gradient(135deg, #79060d 0%, #003b59 100%); color: white; border: none; border-radius: 10px; padding: 0.6rem 2rem; font-size: 1.1rem; font-weight: 600;" data-bs-dismiss="modal">Done</button>
      </div>
    </div>
  </div>
</div>

<!-- Checkout Code Entry Modal -->
<div class="modal fade" id="checkoutCodeModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered" style="max-width: 450px;">
    <div class="modal-content" style="border-radius: 15px; overflow: hidden; border: 3px solid #79060d;">
      <div class="modal-header" style="background: linear-gradient(135deg, #79060d 0%, #003b59 100%); color: white; border: none; padding: 1rem;">
        <h5 class="modal-title" style="font-size: 1.3rem; font-weight: 700;">üîí Enter Checkout Code</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" style="padding: 1.5rem;">
        <p class="text-center mb-3" style="font-size: 1.1rem; font-weight: 600; color: #333;" id="checkout-kid-name"></p>
        <form id="checkout-code-form">
          <div class="mb-3">
            <label for="checkout-code-input" class="form-label text-center w-100" style="font-weight: 600; color: #555;">Checkout Code:</label>
            <input type="text" class="form-control form-control-lg text-center" id="checkout-code-input" 
                   style="font-size: 1.8rem; letter-spacing: 0.3rem; font-family: 'Courier New', monospace; border: 2px solid #79060d; font-weight: bold; padding: 0.75rem;"
                   maxlength="10" required autocomplete="off" inputmode="none">
          </div>
          
          <!-- On-screen keypad -->
          <div id="checkout-keypad" class="mb-3">
            <div class="d-grid gap-2" style="grid-template-columns: repeat(3, 1fr); display: grid;">
              <button type="button" class="btn btn-outline-secondary checkout-key" data-value="1" style="font-size: 1.4rem; padding: 0.7rem; font-weight: 600;">1</button>
              <button type="button" class="btn btn-outline-secondary checkout-key" data-value="2" style="font-size: 1.4rem; padding: 0.7rem; font-weight: 600;">2</button>
              <button type="button" class="btn btn-outline-secondary checkout-key" data-value="3" style="font-size: 1.4rem; padding: 0.7rem; font-weight: 600;">3</button>
              <button type="button" class="btn btn-outline-secondary checkout-key" data-value="4" style="font-size: 1.4rem; padding: 0.7rem; font-weight: 600;">4</button>
              <button type="button" class="btn btn-outline-secondary checkout-key" data-value="5" style="font-size: 1.4rem; padding: 0.7rem; font-weight: 600;">5</button>
              <button type="button" class="btn btn-outline-secondary checkout-key" data-value="6" style="font-size: 1.4rem; padding: 0.7rem; font-weight: 600;">6</button>
              <button type="button" class="btn btn-outline-secondary checkout-key" data-value="7" style="font-size: 1.4rem; padding: 0.7rem; font-weight: 600;">7</button>
              <button type="button" class="btn btn-outline-secondary checkout-key" data-value="8" style="font-size: 1.4rem; padding: 0.7rem; font-weight: 600;">8</button>
              <button type="button" class="btn btn-outline-secondary checkout-key" data-value="9" style="font-size: 1.4rem; padding: 0.7rem; font-weight: 600;">9</button>
              <button type="button" class="btn btn-outline-danger" id="checkout-keypad-clear" style="font-size: 1.1rem; padding: 0.7rem; font-weight: 600;">Clear</button>
              <button type="button" class="btn btn-outline-secondary checkout-key" data-value="0" style="font-size: 1.4rem; padding: 0.7rem; font-weight: 600;">0</button>
              <button type="button" class="btn btn-outline-warning" id="checkout-keypad-back" style="font-size: 1.1rem; padding: 0.7rem; font-weight: 600;">‚Üê</button>
            </div>
          </div>
          
          <div class="d-grid gap-2">
            <button type="submit" class="btn btn-lg" style="background: linear-gradient(135deg, #4a582d 0%, #79060d 100%); color: white; border: none; border-radius: 10px; padding: 0.75rem; font-size: 1.1rem; font-weight: 600;">
              ‚úì Check Out
            </button>
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal" style="border-radius: 10px; padding: 0.6rem;">
              Cancel
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
function showQRCodeModal(qrCodeData, checkoutCode) {
    document.getElementById('qr-code-img').src = qrCodeData;
    document.getElementById('qr-code-text').textContent = checkoutCode || '';
    new bootstrap.Modal(document.getElementById('qrCodeModal')).show();
}

// Fullscreen buttons (both in navbar and fallback)
['fullscreen-btn', 'fullscreen-btn-nav'].forEach(function(btnId) {
    const btn = document.getElementById(btnId);
    if (btn) {
        btn.addEventListener('click', function() {
            if (document.documentElement.requestFullscreen) {
                document.documentElement.requestFullscreen();
            } else if (document.documentElement.webkitRequestFullscreen) { // Safari
                document.documentElement.webkitRequestFullscreen();
            } else if (document.documentElement.msRequestFullscreen) { // IE11
                document.documentElement.msRequestFullscreen();
            }
        });
    }
});

// Auto-refresh every 60 seconds if modal not open
setInterval(function() {
    if (!document.querySelector('.modal.show')) {
        location.reload();
    }
}, 60000);
document.getElementById('checkin-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const phone = document.getElementById('phone').value;
    const eventId = document.getElementById('event-id').value;
    fetch('/checkin_last4', {
        method: 'POST',
        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
        body: new URLSearchParams({last4: phone, event_id: eventId})
    })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert(data.error);
            } else {
                showFamilyModal(data);
            }
        });
});

// Keypad handling for touch screens
;(function() {
    const keypad = document.getElementById('keypad');
    if (!keypad) return;
    const phoneInput = document.getElementById('phone');
    const keys = keypad.querySelectorAll('.keypad-key');
    const back = document.getElementById('keypad-back');
    const clear = document.getElementById('keypad-clear');
    const pasteBtn = document.getElementById('paste-btn');

    function setPhone(v) {
        // enforce digits and max length 4
        v = String(v).replace(/\D/g, '').slice(0, 4);
        phoneInput.value = v;
        // Instant search when 4 digits
        if (v.length === 4) {
            setTimeout(() => document.getElementById('checkin-form').dispatchEvent(new Event('submit')), 100);
        }
    }


})();

function showFamilyModal(data) {
    const modalBody = document.getElementById('modal-body');
    // Build modal HTML from the data object (avoid Jinja/template literal mixing)
    let html = '';
    html += `<p style="font-size: 1.4rem; margin-bottom: 0.5rem;"><strong>Family:</strong> ${data.phone} - Troop ${data.troop}</p>`;
    html += `<p style="font-size: 0.9rem; color: #666; margin-bottom: 1.5rem;">{{ current_event_name }} - {{ current_event_date }}</p>`;
    html += `<form id="checkin-selected-form">`;
    html += `<input type="hidden" name="family_id" value="${data.family_id}">`;
    html += `<input type="hidden" name="event_id" value="{{ current_event_id }}">`;

    // Adult selector
    html += `<div class="mb-3 adult-selector">`;
    html += `<label class="form-label" for="adult-select">Select Adult Checking In:</label>`;
    html += `<select id="adult-select" name="adult_id" class="form-select" required>`;
    html += `<option value="">Choose adult...</option>`;
    (data.adults || []).forEach(function(adult, index) {
        // Select the default adult if specified, otherwise select the first one
        const isSelected = data.default_adult_id ? adult.id === data.default_adult_id : index === 0;
        html += `<option value="${adult.id}" ${isSelected ? 'selected' : ''}>${adult.name}</option>`;
    });
    html += `</select></div>`;

    // Kids checkboxes
    html += `<div class="mb-3 kid-section">`;
    html += `<label class="form-label">Select Kids to Check In:</label>`;
    html += `<div class="kid-options">`;
    (data.kids || []).forEach(function(kid) {
        const kidId = `kid-${kid.id}`;
        html += `<label class="kid-option" for="${kidId}">`;
        html += `<input class="form-check-input" type="checkbox" name="kid_ids" value="${kid.id}" id="${kidId}">`;
        html += `<span class="kid-name">${kid.name}</span>`;
        html += `</label>`;
    });
    html += `</div>`;
    html += `</div>`;

    html += `<button type="submit" class="btn btn-lg w-100 modal-submit" style="background-color: #4a582d; color: white; border: none;">Check In Selected</button>`;
    html += `</form>`;
    html += `<button type="button" class="btn btn-outline-danger position-absolute" data-bs-dismiss="modal" style="top: 0.5rem; right: 0.5rem; font-size: 1.5rem; width: 2.5rem; height: 2.5rem; padding: 0; line-height: 1; border-color: #79060d; color: #79060d;" title="Wrong family">‚úï</button>`;

    modalBody.innerHTML = html;

    const modal = bootstrap.Modal.getOrCreateInstance(document.getElementById('familyModal'));
    modal.show();

    // Wire up the submit handler for the dynamically-created form
    const selForm = document.getElementById('checkin-selected-form');
    if (selForm) {
        selForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            fetch('/checkin_selected', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(resp => {
                if (resp.success) {
                    modal.hide();
                    
                    // Show QR code if available
                    if (resp.qr_code) {
                        showQRCodeModal(resp.qr_code, resp.checkout_code);
                    }
                    
                    // Print labels if any were returned (deferred to prevent UI blocking)
                    if (resp.labels && resp.labels.length > 0) {
                        resp.labels.forEach(label => {
                            setTimeout(() => {
                                printDymoLabel(
                                    label.kid_name,
                                    label.event_name,
                                    label.event_date,
                                    label.checkin_time,
                                    label.checkout_code
                                );
                            }, 0);
                        });
                    }
                    
                    // Add check-ins to the page dynamically first (for immediate feedback)
                    if (resp.checkins && resp.checkins.length > 0) {
                        const checkedInDiv = document.getElementById('checked-in-list');
                        const eventId = document.querySelector('[name="event_id"]').value;
                        
                        resp.checkins.forEach(checkin => {
                            const card = document.createElement('div');
                            card.className = 'card mb-2';
                            card.innerHTML = `
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div>
                                            <h5 class="card-title mb-1">${checkin.kid_name}
                                                ${checkin.kid_notes ? '<i class="bi bi-sticky text-muted" style="font-size: 0.7rem; opacity: 0.6;" data-bs-toggle="tooltip" title="' + checkin.kid_notes + '">üìã</i>' : ''}
                                                ${checkin.authorized_adults ? '<i class="bi bi-person-check text-muted" style="font-size: 0.7rem; opacity: 0.6;" data-bs-toggle="tooltip" title="Authorized: ' + checkin.authorized_adults + '">üë§</i>' : ''}
                                            </h5>
                                            <p class="card-text mb-0">
                                                <small class="text-muted">
                                                    <strong>${checkin.adult_name}</strong> ‚Ä¢ ${checkin.phone}<br>
                                                    ${checkin.formatted_time}
                                                </small>
                                            </p>
                                        </div>
                                        <button class="btn btn-danger btn-sm checkout-btn" 
                                                data-kid-id="${checkin.kid_id}" 
                                                data-kid-name="${checkin.kid_name}"
                                                data-event-id="${eventId}">Check Out</button>
                                    </div>
                                </div>
                            `;
                            checkedInDiv.insertBefore(card, checkedInDiv.firstChild);
                            
                            // Initialize tooltips for this card
                            const tooltips = card.querySelectorAll('[data-bs-toggle="tooltip"]');
                            tooltips.forEach(el => new bootstrap.Tooltip(el));
                        });
                        
                        // Update count in header
                        const countBadge = document.querySelector('h2 .badge');
                        if (countBadge) {
                            const currentCount = parseInt(countBadge.textContent) || 0;
                            countBadge.textContent = currentCount + resp.checkins.length;
                        }
                    }
                    
                    // Show success message
                    if (resp.message) {
                        const alert = document.createElement('div');
                        alert.className = 'alert alert-success alert-dismissible fade show';
                        alert.innerHTML = `
                            ${resp.message}
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        `;
                        document.querySelector('.container').insertBefore(alert, document.querySelector('.container').firstChild);
                        setTimeout(() => alert.remove(), 3000);
                    }
                } else {
                    alert('Error: ' + (resp.message || 'Unknown'));
                }
            })
            .catch(err => {
                console.error('checkin_selected error', err);
                alert('Network error while checking in');
            });
        });
    }
}

// Keypad handling for touch screens
document.addEventListener('DOMContentLoaded', function() {
    const keypad = document.getElementById('keypad');
    if (!keypad) {
        console.error('Keypad not found');
        return;
    }
    const phoneInput = document.getElementById('phone');
    if (!phoneInput) {
        console.error('Phone input not found');
        return;
    }
    const keys = keypad.querySelectorAll('.keypad-key');
    const back = document.getElementById('keypad-back');
    const clear = document.getElementById('keypad-clear');

    console.log('Keypad initialized with', keys.length, 'keys');

    function setPhone(v) {
        // enforce digits and max length 4
        v = String(v).replace(/\D/g, '').slice(0, 4);
        phoneInput.value = v;
        console.log('Phone value set to:', v);
        // Instant search when 4 digits
        if (v.length === 4) {
            setTimeout(() => {
                console.log('Auto-submitting form');
                document.getElementById('checkin-form').dispatchEvent(new Event('submit'));
            }, 100);
        }
    }

    keys.forEach(k => {
        k.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            const val = this.dataset.value;
            console.log('Key clicked:', val);
            setPhone((phoneInput.value || '') + val);
            phoneInput.focus(); // Re-focus input after click
        });
    });

    if (back) {
        back.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            setPhone((phoneInput.value || '').slice(0, -1));
            phoneInput.focus(); // Re-focus input after click
        });
    }

    if (clear) {
        clear.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            setPhone('');
            phoneInput.focus(); // Re-focus input after click
        });
    }

    // instant search on input change (for keyboard typing)
    phoneInput.addEventListener('input', function() {
        if (this.value.length === 4) {
            setTimeout(() => document.getElementById('checkin-form').dispatchEvent(new Event('submit')), 100);
        }
    });

    // allow Enter on keyboard
    phoneInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            document.getElementById('search-btn').click();
        }
    });

    // quick tap feedback
    keypad.addEventListener('touchstart', function(e) {
        const btn = e.target.closest('button');
        if (btn) btn.classList.add('active');
    }, {passive: true});
    keypad.addEventListener('touchend', function(e) {
        const btn = e.target.closest('button');
        if (btn) btn.classList.remove('active');
    });

    // Auto-focus the phone input on page load
    phoneInput.focus();
});

// Handle checkout with code verification
let currentCheckoutData = null;

document.addEventListener('click', function(e) {
    if (e.target.classList.contains('checkout-btn')) {
        const kidId = e.target.dataset.kidId;
        const kidName = e.target.dataset.kidName;
        const eventId = e.target.dataset.eventId;
        
        // Store data for later use
        currentCheckoutData = { kidId, kidName, eventId };
        
        // First, check out without code to see if code is required
        const formData = new FormData();
        formData.append('event_id', eventId);
        
        fetch(`/checkout/${kidId}`, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else if (data.code_required) {
                // Show modal for checkout code
                document.getElementById('checkout-kid-name').textContent = kidName;
                document.getElementById('checkout-code-input').value = '';
                const modal = new bootstrap.Modal(document.getElementById('checkoutCodeModal'));
                modal.show();
                // Focus input after modal is shown
                document.getElementById('checkoutCodeModal').addEventListener('shown.bs.modal', function() {
                    document.getElementById('checkout-code-input').focus();
                }, { once: true });
            } else {
                alert(data.message || 'Checkout failed');
            }
        })
        .catch(error => console.error('Error:', error));
    }
});

// Checkout code keypad handlers
document.addEventListener('DOMContentLoaded', function() {
    const checkoutInput = document.getElementById('checkout-code-input');
    const checkoutKeys = document.querySelectorAll('.checkout-key');
    const checkoutBack = document.getElementById('checkout-keypad-back');
    const checkoutClear = document.getElementById('checkout-keypad-clear');
    
    checkoutKeys.forEach(key => {
        key.addEventListener('click', function() {
            const value = this.dataset.value;
            if (checkoutInput.value.length < 10) {
                checkoutInput.value += value;
            }
        });
    });
    
    if (checkoutBack) {
        checkoutBack.addEventListener('click', function() {
            checkoutInput.value = checkoutInput.value.slice(0, -1);
        });
    }
    
    if (checkoutClear) {
        checkoutClear.addEventListener('click', function() {
            checkoutInput.value = '';
        });
    }
});

// Handle checkout code form submission
document.getElementById('checkout-code-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    if (!currentCheckoutData) return;
    
    const code = document.getElementById('checkout-code-input').value.trim();
    if (!code) return;
    
    const codeFormData = new FormData();
    codeFormData.append('event_id', currentCheckoutData.eventId);
    codeFormData.append('checkout_code', code);
    
    fetch(`/checkout/${currentCheckoutData.kidId}`, {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: codeFormData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('checkoutCodeModal')).hide();
            location.reload();
        } else {
            // Show error in modal
            const input = document.getElementById('checkout-code-input');
            input.classList.add('is-invalid');
            input.value = '';
            input.placeholder = data.message || 'Invalid code - try again';
            setTimeout(() => {
                input.classList.remove('is-invalid');
                input.placeholder = '';
            }, 2000);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Network error during checkout');
    });
});

// Enable Bootstrap tooltips
document.addEventListener('DOMContentLoaded', function() {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});
</script>

<style>
/* Prevent text selection on touch */
* {
    -webkit-touch-callout: none;
    -webkit-user-select: none;
    -khtml-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
}

/* Re-enable text selection for form inputs */
input, select, textarea {
    -webkit-user-select: text;
    -khtml-user-select: text;
    -moz-user-select: text;
    -ms-user-select: text;
    user-select: text;
}

body {
    background-color: #f9f7f5;
    font-size: 0.9rem;
    touch-action: manipulation;
    margin: 0;
    padding: 0;
}

.container-fluid {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0.5rem;
}

.card {
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    margin-bottom: 0.5rem;
}

.card-body {
    padding: 1rem;
}

.form-control {
    border-radius: 0.25rem;
    border: 2px solid #ced4da;
}

.form-control:focus {
    border-color: #79060d;
    box-shadow: 0 0 0 0.2rem rgba(121, 6, 13, 0.25);
}

.btn {
    border-radius: 0.25rem;
    border: none;
    font-weight: 600;
    transition: all 0.2s ease;
}

.btn:hover, .btn:focus {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
}

.btn:hover {
    filter: brightness(0.9);
}

.btn:active {
    transform: translateY(0);
}

.table th, .table td {
    padding: 0.5rem;
    vertical-align: middle;
}

.modal-content {
    border-radius: 0.5rem;
    border: none;
}

#familyModal .modal-dialog {
    max-width: 900px;
    width: calc(100% - 2rem);
    margin: 1.5rem auto;
}

#familyModal .modal-header {
    padding: 1rem 1.25rem;
}

#familyModal .modal-title {
    font-size: 1.6rem;
}

#familyModal .modal-body {
    padding: 1rem 1.25rem;
    max-height: 65vh;
    overflow-y: auto;
}

#familyModal .form-label {
    font-size: 1.1rem;
    margin-bottom: 0.4rem;
}

#familyModal .adult-selector select {
    font-size: 1.1rem;
    padding: 0.6rem;
}

.kid-options {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 0.75rem;
}

.kid-option {
    display: flex;
    align-items: center;
    gap: 0.6rem;
    padding: 0.6rem 0.75rem;
    border: 1px solid #dee2e6;
    border-radius: 0.5rem;
    background-color: #fff;
}

.kid-option .form-check-input {
    width: 1.2rem;
    height: 1.2rem;
    margin: 0;
}

.kid-name {
    font-size: 1.1rem;
}

.modal-submit {
    font-size: 1.3rem;
    padding: 0.85rem;
    margin-top: 0.75rem;
}

.modal-header {
    border-bottom: 1px solid #dee2e6;
}

.modal-body {
    max-height: 60vh;
    overflow-y: auto;
}

.form-check {
    background-color: #f8f9fa;
    transition: background-color 0.2s ease;
}

.form-check:hover {
    background-color: #e9ecef;
}

.form-check-input:checked {
    background-color: #4a582d;
    border-color: #4a582d;
}

/* Trail Life USA brand colors */
#search-btn:hover {
    background-color: #5a0408 !important;
}

.modal-submit:hover {
    background-color: #3a4620 !important;
}

/* Touch device optimizations */
@media (pointer: coarse) {
    .form-check-input {
        transform: scale(1.2);
        margin-right: 0.75rem;
    }

    .btn-close {
        width: 2rem;
        height: 2rem;
    }

    .table {
        font-size: 1rem;
    }
}

/* Laptop screens - hide keypad */
@media (max-width: 1366px) {
    body {
        font-size: 0.8rem;
    }

    .container-fluid {
        padding: 0.25rem;
    }

    .card-body {
        padding: 0.75rem;
    }

    #keypad {
        display: none;
    }
}

/* Extra large touch screens */
@media (min-width: 1200px) and (pointer: coarse) {
    .form-control {
        font-size: 1.8rem;
        padding: 1rem;
    }

    .btn {
        font-size: 1.8rem;
        padding: 1rem 1.5rem;
    }

    .form-check-input {
        width: 2rem;
        height: 2rem;
    }

    .form-check-label {
        font-size: 1.4rem;
    }
}
</style>
<script src="/static/dymo_print.js"></script>
{% endblock %}